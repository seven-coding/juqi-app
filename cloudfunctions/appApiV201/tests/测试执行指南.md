# 测试执行指南

## 快速开始

### 运行所有测试

```bash
cd JUQI-APP/cloudfunctions/appApi
node tests/run-all-tests.js
```

### 运行单个模块测试

```bash
# 认证模块（必须先运行以获取token）
node tests/auth-test.js

# 其他模块
node tests/user-test.js
node tests/dyn-test.js
node tests/circle-test.js
node tests/message-test.js
node tests/search-test.js
node tests/upload-test.js
node tests/scenario-test.js
node tests/format-test.js
```

---

## 测试执行顺序

**重要**: 测试必须按以下顺序运行，因为后续测试依赖认证模块生成的token：

1. **auth-test.js** - 认证模块（生成token）
2. **user-test.js** - 用户模块（需要token）
3. **dyn-test.js** - 动态模块（需要token）
4. **circle-test.js** - 圈子模块（需要token）
5. **message-test.js** - 消息模块（需要token）
6. **search-test.js** - 搜索模块（需要token）
7. **upload-test.js** - 上传模块（需要token）
8. **scenario-test.js** - 业务场景（需要token）
9. **format-test.js** - 数据格式（需要token）

**推荐**: 使用 `run-all-tests.js` 自动按正确顺序运行所有测试。

---

## 测试输出说明

### 成功输出示例

```
[测试] 1. appLogin - 登录接口（新用户）...
[✓] 1. appLogin - 登录接口（新用户） - 通过 (1234ms)
  [信息] 获取到token和openId
```

### 失败输出示例

```
[测试] 2. appGetUserInfo - 获取用户信息...
[✗] 2. appGetUserInfo - 获取用户信息 - 失败: 缺少token，无法测试 (567ms)
```

### 跳过输出示例

```
[测试] 6. appPublishDyn - 发布动态...
  [跳过] 用户未通过验证，无法发布动态（正常）
[✓] 6. appPublishDyn - 发布动态 - 通过 (890ms)
```

---

## 测试结果解读

### 通过率

- **100%**: 所有测试通过，可以继续开发
- **90-99%**: 大部分测试通过，需要修复失败用例
- **<90%**: 需要重点修复问题

### 常见跳过原因

1. **用户未通过验证**: 测试用户可能未通过验证，某些操作会返回403
2. **没有数据**: 测试环境可能没有相应的数据（如动态、用户等）
3. **已存在**: 某些操作（如关注、加入圈子）可能已经执行过

这些跳过是**正常的**，不影响测试有效性。

---

## 问题排查

### 问题1: 所有测试都失败，提示"缺少token"

**原因**: 认证模块测试未运行或失败

**解决**: 
1. 先单独运行 `node tests/auth-test.js`
2. 检查登录接口是否正常
3. 确认测试环境配置正确

### 问题2: 某些测试一直跳过

**原因**: 测试环境缺少必要数据

**解决**:
1. 在测试环境中创建测试数据
2. 或者修改测试用例使用现有数据

### 问题3: 数据格式验证失败

**原因**: 云函数返回格式与iOS App模型不匹配

**解决**:
1. 检查数据转换函数是否正确
2. 对比云函数返回格式与iOS App模型
3. 修复数据转换逻辑

---

## 测试覆盖率

### 当前覆盖率

- **接口覆盖率**: 49/49 (100%)
- **功能覆盖率**: 约200+个测试用例
- **场景覆盖率**: 4个完整业务场景

### 测试用例分布

| 模块 | 接口数 | 测试用例数 |
|------|--------|-----------|
| 认证模块 | 5 | ~20 |
| 用户模块 | 15 | ~50 |
| 动态模块 | 11 | ~40 |
| 圈子模块 | 8 | ~25 |
| 消息模块 | 4 | ~15 |
| 搜索模块 | 4 | ~15 |
| 上传模块 | 2 | ~10 |
| 业务场景 | - | 4 |
| 数据格式 | - | 6 |
| **总计** | **49** | **~185** |

---

## 持续集成

### 建议的CI流程

1. 代码提交触发测试
2. 运行所有测试
3. 生成测试报告
4. 如果通过率<90%，阻止合并

### 测试报告

测试完成后，可以：
1. 查看控制台输出
2. 填写 `tests/reports/test-report.md`
3. 记录发现的问题

---

**文档更新时间**: 2026-01-15
