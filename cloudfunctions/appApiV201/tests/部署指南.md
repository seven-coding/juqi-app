# 云函数部署指南

## 需要部署的云函数

根据修复内容，需要部署以下云函数：

### 1. appApi 云函数（P0 - 立即部署）

**位置**: `JUQI-APP/cloudfunctions/appApi/`

**修复内容**:
- ✅ 路由配置修复（appGetUnreadCount, appMarkMessagesRead）
- ✅ 搜索话题路由修复
- ✅ 数据格式转换修复

**部署方式**:

#### 方式1: 使用微信开发者工具（推荐）

1. 打开微信开发者工具
2. 打开项目 `JUQI-APP`
3. 进入"云开发" → "云函数"
4. 找到 `appApi` 云函数
5. 右键 → "上传并部署：云端安装依赖"

#### 方式2: 使用 CloudBase CLI

```bash
cd JUQI-APP/cloudfunctions
tcb functions:deploy appApi --force
```

#### 方式3: 手动上传

1. 登录腾讯云控制台
2. 云开发 → 云函数 → `appApi`
3. 上传代码包：`JUQI-APP/cloudfunctions/appApi/`
4. 点击"部署"

---

### 2. getUserList 云函数（P0 - 立即部署）

**位置**: `JUQI-小程序/cloudfunctions/getUserList/`

**修复内容**:
- ✅ 添加 getCharging 函数导入
- ✅ 添加 getCircleFollower 函数导入

**部署方式**:

#### 方式1: 使用微信开发者工具（推荐）

1. 打开微信开发者工具
2. 打开项目 `JUQI-小程序`
3. 进入"云开发" → "云函数"
4. 找到 `getUserList` 云函数
5. 右键 → "上传并部署：云端安装依赖"

#### 方式2: 手动上传

1. 登录腾讯云控制台
2. 云开发 → 云函数 → `getUserList`
3. 上传代码包：`JUQI-小程序/cloudfunctions/getUserList/`
4. 点击"部署"

---

### 3. getDynsListV2 云函数（P0 - 立即部署）

**位置**: `JUQI-小程序/cloudfunctions/getDynsListV2/`

**修复内容**:
- ✅ 修复 dealFavoriteDynListData 中的 item 变量错误

**部署方式**:

#### 方式1: 使用微信开发者工具（推荐）

1. 打开微信开发者工具
2. 打开项目 `JUQI-小程序`
3. 进入"云开发" → "云函数"
4. 找到 `getDynsListV2` 云函数
5. 右键 → "上传并部署：云端安装依赖"

#### 方式2: 手动上传

1. 登录腾讯云控制台
2. 云开发 → 云函数 → `getDynsListV2`
3. 上传代码包：`JUQI-小程序/cloudfunctions/getDynsListV2/`
4. 点击"部署"

---

### 4. publishDyn 云函数（P1 - 重要部署）

**位置**: `JUQI-小程序/cloudfunctions/publishDyn/`

**修复内容**:
- ✅ 修复 getUserInfo 中的 JSON.parse 错误处理

**部署方式**:

#### 方式1: 使用微信开发者工具（推荐）

1. 打开微信开发者工具
2. 打开项目 `JUQI-小程序`
3. 进入"云开发" → "云函数"
4. 找到 `publishDyn` 云函数
5. 右键 → "上传并部署：云端安装依赖"

---

### 5. 其他工具函数（P1 - 重要部署）

以下文件中的 getUserInfo 函数已修复 JSON.parse 错误处理：

1. `JUQI-小程序/cloudfunctions/getDynsListV2/utils/userInfo.js`
2. `JUQI-小程序/cloudfunctions/common/utils/userInfo.js`
3. `JUQI-小程序/cloudfunctions/commonRequest/userInfo/user.js`

这些文件会被包含在相应的云函数中，部署相关云函数时会自动更新。

---

## 部署顺序建议

### 第一步：部署核心层云函数（必须先部署）

1. ✅ getUserList
2. ✅ getDynsListV2
3. ✅ publishDyn

### 第二步：部署 appApi 云函数

4. ✅ appApi

---

## 部署验证

部署完成后，运行测试验证：

```bash
cd JUQI-APP/cloudfunctions/appApi
export TENCENT_SECRET_ID="你的SecretId"
export TENCENT_SECRET_KEY="你的SecretKey"
export TCB_ENV_ID="test-juqi-3g1m5qa7cc2737a1"
node tests/run-all-tests.js
```

### 预期改进

部署后，以下接口应该能正常工作：

1. ✅ appGetChargeList - 获取充电列表（修复 getCharging 导入）
2. ✅ appGetFavoriteList - 获取收藏列表（修复 item 变量）
3. ✅ appPublishDyn - 发布动态（修复 JSON.parse）
4. ✅ appGetInviteCount - 获取邀请数量（修复 JSON.parse）
5. ✅ appGetUnreadCount - 获取未读消息数（修复路由）
6. ✅ appMarkMessagesRead - 批量标记已读（修复路由）
7. ✅ appSearchTopic - 搜索话题（修复路由）

### 预期通过率

- **部署前**: 57.14% (48/84)
- **部署后**: 70%+ (59+/84)

---

## 注意事项

1. **环境确认**: 确保部署到测试环境 `test-juqi-3g1m5qa7cc2737a1`
2. **依赖安装**: 部署时选择"云端安装依赖"
3. **版本控制**: 建议在部署前备份当前版本
4. **测试验证**: 部署后立即运行测试验证修复效果

---

**最后更新**: 2026-01-18
