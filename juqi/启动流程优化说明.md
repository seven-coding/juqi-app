# 启动流程优化说明

## 优化概述

本次优化统一管理应用启动流程，确保系统级服务、网络权限、用户认证按正确顺序初始化，并区分测试环境和生产环境的登录行为。

## 优化后的启动流程

### 1. 应用入口 (`juqiApp.swift`)

```
应用启动
  ↓
显示启动画面 (LaunchScreenView)
  ↓
调用 AppInitializer.initialize()
  ↓
初始化完成后显示 RootView
```

### 2. 初始化流程 (`AppInitializer.swift`)

#### 阶段1：系统级初始化（同步）
1. **崩溃监控** (`CrashReporter`)
   - 设置未捕获异常处理器
   - 设置信号处理器（SIGABRT, SIGILL, SIGSEGV等）
   - 创建崩溃日志目录

2. **微信SDK**
   - 在 `AppDelegate.didFinishLaunchingWithOptions` 中注册
   - Universal Link: `https://app.juqi.life/app/`

3. **网络服务** (`NetworkService`)
   - 配置 URLSession
   - 准备网络监控（延迟启动）

4. **数据同步服务** (`DataSyncService`)
   - 初始化同步队列

#### 阶段2：网络权限请求（异步）
- iOS 14+ 本地网络权限已在 Info.plist 配置
- 延迟启动网络监控，避免启动时隐私权限崩溃

#### 阶段3：用户认证初始化（异步）

**测试环境 (DEBUG)**:
- 默认每次打开都清除 token，显示登录页
- 可通过 `UserDefaults.standard.set(false, forKey: "forceLoginOnLaunch")` 禁用

**生产环境 (RELEASE)**:
- 从 Keychain 读取 token
- 验证 token 有效性
- 如果 token 有效，自动登录（免登）
- 如果 token 无效，显示登录页

### 3. 认证服务 (`AuthService.swift`)

#### 优化点：
1. **移除 init 中的自动检查**
   - 避免初始化顺序问题
   - 由 `AppInitializer` 统一管理

2. **异步检查认证状态**
   - `checkAuthState()` 改为 `async` 方法
   - 支持测试环境的强制登录控制

3. **改进 Token 验证**
   - 验证失败时正确处理状态
   - 测试模式下网络错误不自动登出

### 4. 根视图 (`RootView.swift`)

#### 修复：
- 使用 `@EnvironmentObject` 替代 `@StateObject`
- 确保使用共享的 `AuthService` 实例
- 避免创建多个实例导致状态不一致

### 5. 网络服务 (`NetworkService.swift`)

#### 优化：
- 移除 init 中的 token 读取
- 由 `AuthService` 统一管理 token
- 避免重复读取和初始化顺序问题

## 测试环境配置

### 默认行为
- 每次打开应用都清除 token，显示登录页
- 方便测试登录流程

### 禁用强制登录
```swift
// 在应用启动前设置（例如在 AppDelegate 中）
UserDefaults.standard.set(false, forKey: "forceLoginOnLaunch")
```

### 测试登录方法
在 `LoginView` 中提供了三个测试登录按钮：
1. **测试登录（会员）** - 模拟会员用户
2. **试用期** - 模拟试用期用户
3. **待验证** - 模拟待验证用户

## 生产环境行为

### 免登流程
1. 应用启动
2. `AppInitializer` 初始化
3. `AuthService` 从 Keychain 读取 token
4. 验证 token 有效性
5. 如果有效，自动登录，显示主界面
6. 如果无效，显示登录页

### Token 管理
- Token 存储在 Keychain 中（安全）
- Token 由 `AuthService` 统一管理
- `NetworkService` 通过 `setToken()` 方法同步 token

## 初始化顺序保证

```
1. CrashReporter (最早，捕获所有崩溃)
2. NetworkService (配置网络)
3. DataSyncService (数据同步)
4. 网络权限请求
5. AuthService.checkAuthState() (用户认证)
```

## 错误处理

1. **初始化失败**
   - 记录错误日志
   - 仍然显示界面，让用户知道发生了什么

2. **Token 验证失败**
   - 清除无效 token
   - 显示登录页

3. **网络错误**
   - 测试模式：不自动登出
   - 生产模式：根据错误类型决定是否登出

## 后续任务

初始化完成后，异步执行：
- 恢复失败的数据同步任务
- 上传崩溃日志

## 注意事项

1. **测试环境**
   - 默认每次打开都显示登录页
   - 如需测试免登，设置 `forceLoginOnLaunch = false`

2. **生产环境**
   - 已登录用户自动免登
   - Token 验证失败时自动登出

3. **网络权限**
   - 已在 Info.plist 配置 `NSLocalNetworkUsageDescription`
   - 网络监控延迟启动，避免权限问题

4. **微信SDK**
   - 在 `AppDelegate` 中注册
   - Universal Link 已配置
