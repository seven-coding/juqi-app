# 环境变量配置说明

## 配置验证结果

✅ **你的测试环境配置是正确的！**

### API Key 验证信息

从你提供的API Key解析结果：

```json
{
    "aud": "test-juqi-3g1m5qa7cc2737a1",  // 环境ID，正确 ✅
    "project_id": "test-juqi-3g1m5qa7cc2737a1",  // 项目ID，正确 ✅
    "exp": 1771060002,  // 过期时间：2026年2月（有效）✅
    "meta": {
        "platform": "ApiKey"  // 确认是API Key类型 ✅
    },
    "is_system_admin": true  // 有管理员权限 ✅
}
```

## 环境变量配置

### 测试环境配置

创建 `.env` 文件（不要提交到仓库）：

```bash
# 运行环境
NODE_ENV=test

# 云开发凭证（用于调用云函数）
# 注意：API Key用于HTTP API调用，Node SDK需要使用SecretId/SecretKey
CLOUD_BASE_ID=你的SecretId
CLOUD_BASE_KEY=你的SecretKey

# 测试环境ID
TCB_ENV_TEST=test-juqi-3g1m5qa7cc2737a1

# 生产环境ID（用于数据同步等场景）
TCB_ENV_PROD=prod-juqi-7glu2m8qfa31e13f

# 服务端口
PORT=9999
```

### 生产环境配置

```bash
# 运行环境
NODE_ENV=production

# 云开发凭证
CLOUD_BASE_ID=你的SecretId
CLOUD_BASE_KEY=你的SecretKey

# 生产环境ID
TCB_ENV_PROD=prod-juqi-7glu2m8qfa31e13f

# 服务端口
PORT=9999
```

## 环境变量说明

### 1. API Key vs SecretId/SecretKey

**两种认证方式：**

- **API Key (JWT Token)**: 
  - 用于HTTP API调用
  - 格式：JWT token
  - 你提供的就是这种类型 ✅

- **SecretId/SecretKey**:
  - 用于Node SDK调用云函数
  - 格式：两个独立的字符串
  - 需要从"访问管理 → API密钥管理"获取

### 2. 使用场景

**使用API Key的场景：**
- HTTP API调用（RESTful接口）
- 云托管服务通过HTTP调用云函数
- 外部服务调用云开发接口

**使用SecretId/SecretKey的场景：**
- Node SDK的 `callFunction` 方法
- 云函数内部调用其他云函数
- 需要完整SDK功能的场景

### 3. 配置建议

**对于App API服务（云托管）：**

由于云托管服务需要通过Node SDK调用云函数，建议：

1. **使用SecretId/SecretKey**（推荐）
   - 通过Node SDK的callFunction
   - 功能更完整
   - 需要从API密钥管理获取

2. **使用API Key**（备选）
   - 通过HTTP API调用云函数
   - 配置简单，但功能受限

## 下一步

1. ✅ 测试环境配置已完成
2. ⏳ 需要获取生产环境的SecretId/SecretKey（如果使用Node SDK方式）
3. ⏳ 如果使用API Key方式，需要获取生产环境的API Key

## 正式环境只读（开发不影响线上）

为保障开发、联调时不影响正式环境数据，建议对正式环境仅使用**只读权限**的密钥：

- 在腾讯云 CAM 中为「开发用」密钥对正式环境仅授予只读策略（可查看、查询，不能增删改）。
- 本地需要连正式环境做只读联调时，在 `.env` 中配置正式环境只读凭证，并连接正式环境；apiServer 会仅允许只读类操作。

**配置方式：**

- 可选环境变量：`CLOUD_BASE_ID_PROD_READONLY`、`CLOUD_BASE_KEY_PROD_READONLY`（正式环境只读密钥）。
- 当当前连接的是正式环境且配置了上述两个变量时，将使用只读密钥，且接口层会拒绝非只读操作（返回 403）。

详细步骤见：[正式环境只读权限配置.md](./正式环境只读权限配置.md)。

## 降本：直连开关（可选）

以下环境变量控制 apiServer 是否对部分接口使用「直连数据库」而非调用云函数。设为 `true` 可减少云函数调用量，降低云开发费用。云托管部署时建议按需开启。

| 环境变量 | 作用 | 建议 |
|----------|------|------|
| `MIGRATION_DYN_LIST` | 动态列表走直连；未显式设置时，详情与充电会跟随此项（与列表同源） | 建议 `true` |
| `MIGRATION_USER_PROFILE` | 当前用户资料走直连 | 建议 `true` |
| `MIGRATION_UNREAD_COUNT` | 未读消息数走直连 | 建议 `true` |
| `MIGRATION_MESSAGE_LIST` | 消息列表走直连 | 建议 `true` |
| `MIGRATION_CHAT_LIST` | 私信列表走直连 | 建议 `true` |
| `MIGRATION_DYN_DETAIL` | 动态详情（不设时跟随 MIGRATION_DYN_LIST） | 可选 |
| `MIGRATION_DYN_CHARGE` | 充电动态（不设时跟随 MIGRATION_DYN_LIST） | 可选 |

详见 [2025年腾讯云账单与优化分析](../docs/2025年腾讯云账单与优化分析.md)。

## 注意事项

⚠️ **安全提醒：**
- `.env` 文件包含敏感信息，已添加到 `.gitignore`
- 不要将 `.env` 文件提交到代码仓库
- API Key和SecretKey不要分享给他人
- 定期轮换密钥
