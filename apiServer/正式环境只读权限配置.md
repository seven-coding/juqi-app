# 正式环境只读权限配置

为保障开发、联调时不影响线上数据，建议在腾讯云 CAM 中为「开发用」的 API 密钥对正式环境**仅授予只读权限**：可查看、查询，不能增删改。

## 一、在腾讯云 CAM 中配置只读策略

### 1. 创建自定义策略（只读）

1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入 **访问管理 (CAM)** → **策略** → **创建策略**
3. 选择 **按策略语法创建** → **空白模板**
4. 策略名称建议：`TCB-正式环境只读-juqi`
5. 策略内容使用下面 JSON（将 `prod-juqi-7glu2m8qfa31e13f` 换成你的正式环境 ID（如有需要））：

```json
{
  "version": "2.0",
  "statement": [
    {
      "effect": "allow",
      "action": [
        "tcb:QueryDocument",
        "tcb:AggregateDocument",
        "tcb:ExplainQuery",
        "tcb:GetFileAuthority",
        "tcb:GetDownloadUrl",
        "tcb:QueryUserInfo",
        "tcb:InvokeFunction"
      ],
      "resource": [
        "qcs::tcb:::env/prod-juqi-7glu2m8qfa31e13f",
        "qcs::tcb:ap-guangzhou::env/prod-juqi-7glu2m8qfa31e13f"
      ]
    }
  ]
}
```

**说明：**

- **只读相关 Action（已包含）：**
  - `tcb:QueryDocument` - 查询数据
  - `tcb:AggregateDocument` - 聚合数据
  - `tcb:ExplainQuery` - 查询分析
  - `tcb:GetFileAuthority` - 获取文件权限
  - `tcb:GetDownloadUrl` - 获取文件下载地址
  - `tcb:QueryUserInfo` - 获取用户信息
  - `tcb:InvokeFunction` - 调用云函数（若云函数内写库，仍会受数据库只读权限限制）

- **未授予的写操作（无法执行）：**
  - `tcb:InsertDocument` - 插入
  - `tcb:UpdateDocument` - 更新
  - `tcb:DeleteDocument` - 删除
  - `tcb:RunTransaction` - 事务
  - `tcb:UploadFile` - 上传文件
  - `tcb:DeleteFile` - 删除文件

- **resource**：仅包含正式环境 ID；区域 `ap-guangzhou` 请按你实际使用的区域修改（可在云开发控制台环境概览中查看）。

### 2. 将策略绑定到「开发用」身份

任选其一：

**方式 A：子用户**

1. **访问管理** → **用户** → **用户列表** → 选择用于开发的子用户（或新建）
2. 在用户详情中点击 **关联策略**，选择刚创建的策略 `TCB-正式环境只读-juqi`
3. 在该子用户下 **API 密钥** 中创建或使用现有 SecretId/SecretKey，用于本地或测试环境

**方式 B：当前主账号的协作者/密钥**

1. 若使用主账号下的 API 密钥做开发，可新建一个**仅用于开发**的 API 密钥
2. 主账号密钥权限较大，更推荐：**新建子用户**，只授予上述「正式环境只读」策略，用该子用户的密钥做开发

### 3. 使用只读密钥访问正式环境

- 开发、联调需要**连正式环境**时，在 `.env` 或环境变量中配置的 `CLOUD_BASE_ID` / `CLOUD_BASE_KEY` 使用上述**只读权限**的 SecretId/SecretKey。
- 本机 apiServer 会根据 `NODE_ENV` 等选择环境；当连接的是正式环境且使用该只读密钥时，腾讯云会拒绝所有写操作，实现「正式环境只能查看，不能增删改」。

## 二、与本项目 apiServer 的配合

- 当 `NODE_ENV=test` 或 `development` 时，默认连接**测试环境**，可使用具备测试环境完整权限的密钥。
- 当需要连接**正式环境**做只读联调时：
  - 使用上述「只读」策略对应的 SecretId/SecretKey 配置 `CLOUD_BASE_ID` / `CLOUD_BASE_KEY`
  - 并设置连接正式环境（例如通过 `TCB_ENV_PROD` 或当前逻辑中会选用正式环境的配置）
- 线上正式服务应使用具备正式环境**完整权限**的密钥，且不要与开发只读密钥混用。

按上述方式配置后，你在腾讯云中的「开发用」权限对正式环境即为：**仅查看，不能增删改**。

---

**参考：**

- [云开发 - 环境级访问权限控制](https://docs.cloudbase.net/cam/access-manage)
- 腾讯云 CAM：<https://console.cloud.tencent.com/cam>
