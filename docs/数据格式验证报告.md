# 数据格式验证报告

## 文档说明

本文档对比iOS App数据模型与云函数返回格式，识别不匹配的字段，并提供修复建议。

---

## 一、动态(Post)数据格式对比

### 1.1 iOS App期望格式 (Post.swift)

```swift
struct Post: Identifiable, Codable {
    let id: String                    // 动态ID
    let userId: String                // 用户ID
    let userName: String              // 用户名
    let userAvatar: String?          // 用户头像
    let userSignature: String?       // 用户签名
    let isVip: Bool                  // 是否VIP
    let content: String              // 动态内容
    let images: [String]?            // 图片列表
    let tag: PostTag?                // 标签
    let publishTime: Date            // 发布时间
    let commentCount: Int            // 评论数
    let likeCount: Int               // 点赞数
    let shareCount: Int              // 转发数
    let chargeCount: Int             // 充电数
    let isLiked: Bool                // 是否已点赞
    let isCollected: Bool            // 是否已收藏
    let isCharged: Bool              // 是否已充电
    let repostPost: RepostPost?      // 转发动态
    let likeUsers: [LikeUser]?       // 互动用户列表
    let joinCount: Int?              // 参与记录的人数
    let circleId: String?             // 圈子ID
    let circleTitle: String?          // 圈子标题
    let circleJoinCount: Int?         // 圈子参与人数
    let voiceUrl: String?             // 语音URL
    let voiceDuration: TimeInterval?  // 语音时长
    let videoUrl: String?             // 视频URL
    let musicInfo: MusicInfo?         // 音乐信息
}
```

### 1.2 云函数返回格式 (getDynsListV2)

根据核心层返回的数据结构，动态数据包含以下字段：

```javascript
{
  _id: String,                    // 动态ID
  openId: String,                 // 用户openId
  dynContent: String,             // 动态内容
  imageIds: [String],             // 图片ID列表
  imageList: [String],            // 图片列表（URL）
  dynVoice: String,               // 语音文件ID
  dynVoiceLen: Number,            // 语音时长（秒）
  dynVideo: String,               // 视频文件ID
  musicId: String,                // 音乐ID
  musicName: String,              // 音乐名称
  musicAuthor: String,            // 音乐作者
  musicPoster: String,            // 音乐封面
  musicSrc: String,               // 音乐源
  isAudioShow: Boolean,           // 是否显示音频
  circleId: String,               // 圈子ID
  circleTitle: String,             // 圈子标题
  publicTime: Number,             // 发布时间（时间戳）
  likeNums: Number,               // 点赞数
  commentNums: Number,            // 评论数
  forwardNums: Number,            // 转发数
  chargeNums: Number,             // 充电数
  like: [String],                 // 点赞用户openId列表
  // 用户信息（通过关联查询）
  userInfo: {
    openId: String,
    nickName: String,
    avatarVisitUrl: String,
    avatarUrl: String,
    signature: String,
    usersSecret: [{
      vipStatus: Boolean
    }]
  },
  // 转发信息
  forwardInfo: {
    openId: String,
    dynContent: String,
    imageList: [String],
    userInfo: Object
  }
}
```

### 1.3 字段映射关系

| iOS App字段 | 云函数字段 | 转换说明 | 状态 |
|------------|----------|---------|------|
| id | _id | 直接映射 | ✅ |
| userId | openId 或 userInfo.openId | 需要提取 | ⚠️ |
| userName | userInfo.nickName | 需要提取 | ⚠️ |
| userAvatar | userInfo.avatarVisitUrl 或 userInfo.avatarUrl | 需要提取 | ⚠️ |
| userSignature | userInfo.signature | 需要提取 | ⚠️ |
| isVip | userInfo.usersSecret[0].vipStatus | 需要提取 | ⚠️ |
| content | dynContent | 直接映射 | ✅ |
| images | imageList 或 imageIds | 需要选择 | ⚠️ |
| tag | - | 需要从其他字段推导或添加 | ❌ |
| publishTime | publicTime | 需要转换为Date | ⚠️ |
| commentCount | commentNums | 直接映射 | ✅ |
| likeCount | likeNums | 直接映射 | ✅ |
| shareCount | forwardNums | 直接映射 | ✅ |
| chargeCount | chargeNums | 直接映射 | ✅ |
| isLiked | like数组包含当前用户openId | 需要计算 | ⚠️ |
| isCollected | - | 需要从收藏表查询 | ❌ |
| isCharged | - | 需要从充电记录查询 | ❌ |
| repostPost | forwardInfo | 需要转换格式 | ⚠️ |
| likeUsers | like数组 | 需要查询用户信息 | ❌ |
| joinCount | - | 需要从其他数据源获取 | ❌ |
| circleId | circleId | 直接映射 | ✅ |
| circleTitle | circleTitle | 直接映射 | ✅ |
| circleJoinCount | - | 需要从圈子表查询 | ❌ |
| voiceUrl | dynVoice | 需要转换为URL | ⚠️ |
| voiceDuration | dynVoiceLen | 需要转换为TimeInterval | ⚠️ |
| videoUrl | dynVideo | 需要转换为URL | ⚠️ |
| musicInfo | musicId/musicName等 | 需要组装为MusicInfo对象 | ⚠️ |

### 1.4 问题总结

**需要修复的问题**：
1. ❌ **缺少字段映射**：tag, isCollected, isCharged, likeUsers, joinCount, circleJoinCount
2. ⚠️ **需要数据转换**：用户信息提取、时间格式转换、URL转换、数组判断
3. ⚠️ **需要额外查询**：收藏状态、充电状态、互动用户列表

**建议**：
- 在版本层（dyn.js）添加数据格式转换函数
- 将核心层返回的原始数据转换为App所需格式
- 对于需要额外查询的字段，可以在版本层进行补充查询

---

## 二、评论(Comment)数据格式对比

### 2.1 iOS App期望格式 (Comment.swift)

```swift
struct Comment: Identifiable, Codable {
    let id: String                    // 评论ID
    let postId: String                // 动态ID
    let userId: String                // 用户ID
    let userName: String              // 用户名
    let userAvatar: String?           // 用户头像
    let content: String               // 评论内容
    let imagePath: String?            // 评论图片
    let publishTime: Date             // 发布时间
    let likeCount: Int                // 点赞数
    let isLiked: Bool                 // 是否已点赞
    let replies: [Comment]?           // 二级评论
    let mentionedUsers: [MentionedUser]? // @的用户列表
    let replyToUserId: String?        // 回复的用户ID
    let replyToUserName: String?      // 回复的用户名
    let forwardStatus: Bool?          // 是否为转发评论
}
```

### 2.2 云函数返回格式 (GetDynComment)

根据`dyn.js`中的`GetDynComment`函数，返回格式为：

```javascript
{
  list: [{
    id: String,                      // 评论ID (_id)
    postId: String,                  // 动态ID (dynId)
    userId: String,                   // 用户ID (from 或 openId)
    userName: String,                 // 用户名 (fromUser[0].nickName)
    userAvatar: String,               // 用户头像 (fromUser[0].avatarVisitUrl)
    content: String,                  // 评论内容 (commentContent)
    imagePath: String,                // 评论图片 (imagePath)
    publishTime: Date,                // 发布时间 (createTime)
    likeCount: Int,                   // 点赞数 (likeNums 或 like.length)
    isLiked: Bool,                    // 是否已点赞 (like.includes(openId))
    replies: [Comment],               // 二级评论 (从dynCommentReplay查询)
    mentionedUsers: [{
      id: String,                     // @的用户ID (ait[].openId)
      userName: String                 // @的用户名 (ait[].nickName)
    }],
    replyToUserId: String,            // 回复的用户ID (to)
    replyToUserName: String,           // 回复的用户名 (toUser[0].nickName)
    forwardStatus: Bool               // 转发状态 (forwradStatus)
  }],
  total: Number,
  hasMore: Bool
}
```

### 2.3 字段映射关系

| iOS App字段 | 云函数字段 | 转换说明 | 状态 |
|------------|----------|---------|------|
| id | _id | 已转换 | ✅ |
| postId | dynId | 已转换 | ✅ |
| userId | from 或 openId | 已转换 | ✅ |
| userName | fromUser[0].nickName | 已转换 | ✅ |
| userAvatar | fromUser[0].avatarVisitUrl | 已转换 | ✅ |
| content | commentContent | 已转换 | ✅ |
| imagePath | imagePath | 已转换 | ✅ |
| publishTime | createTime | 已转换为Date | ✅ |
| likeCount | likeNums 或 like.length | 已转换 | ✅ |
| isLiked | like.includes(openId) | 已转换 | ✅ |
| replies | dynCommentReplay查询结果 | 已转换 | ✅ |
| mentionedUsers | ait数组转换 | 已转换 | ✅ |
| replyToUserId | to | 已转换 | ✅ |
| replyToUserName | toUser[0].nickName | 已转换 | ✅ |
| forwardStatus | forwradStatus | 已转换 | ✅ |

### 2.4 问题总结

**评论数据格式**：✅ **已完全匹配**

`GetDynComment`函数已经完成了所有必要的数据格式转换，iOS App可以直接使用返回的数据。

---

## 三、用户(User)数据格式对比

### 3.1 iOS App期望格式 (UserProfile.swift)

```swift
struct UserProfile: Identifiable, Codable {
    let id: String
    let userName: String
    let avatar: String?
    let signature: String?
    let isVip: Bool
    let followCount: Int
    let followerCount: Int
    let chargeNums: Int?
    let followStatus: FollowStatus?
    let chargingStatus: Bool?
    let joinStatus: UserJoinStatus?
    let blackStatus: BlackStatus?
    let restStatus: Bool?
    let vipStatus: Bool?
    let vipConfig: VipConfig?
    // ... 其他字段
}
```

### 3.2 云函数返回格式 (GetUserProfile)

根据`user.js`中的`GetUserProfile`函数，返回格式为：

```javascript
{
  userInfo: {
    id: String,                      // 用户ID (_id)
    openId: String,                  // 用户openId
    nickName: String,                 // 用户名
    avatar: String,                  // 头像 (avatarVisitUrl 或 avatarUrl)
    city: String,                    // 城市
    birthDay: String,                 // 生日
    signature: String,                // 签名
    followStatus: Number,            // 关注状态 (1未关注/2已关注/3回关/4互相关注)
    blackStatus: Number,              // 拉黑状态 (1未拉黑/2被拉黑/3拉黑对方/4双方拉黑)
    isInvisible: Boolean,            // 是否不可见
    dynNums: Number,                 // 动态数
    followNums: Number,              // 关注数
    fansNums: Number,                 // 粉丝数
    chargeNums: Number,               // 充电数
    usersSecret: [{                  // 会员信息（仅自己的信息）
      vipStatus: Boolean,
      vipStartTime: Number,
      vipEndTime: Number,
      vipConfig: Object
    }]
  },
  isInvisible: Boolean
}
```

### 3.3 字段映射关系

| iOS App字段 | 云函数字段 | 转换说明 | 状态 |
|------------|----------|---------|------|
| id | id (_id) | 已转换 | ✅ |
| userName | nickName | 已转换 | ✅ |
| avatar | avatar | 已转换 | ✅ |
| signature | signature | 已转换 | ✅ |
| isVip | usersSecret[0].vipStatus | 已转换（仅自己） | ⚠️ |
| followCount | followNums | 已转换 | ✅ |
| followerCount | fansNums | 已转换 | ✅ |
| chargeNums | chargeNums | 已转换 | ✅ |
| followStatus | followStatus | 已转换 | ✅ |
| blackStatus | blackStatus | 已转换 | ✅ |
| joinStatus | - | 需要从user表查询 | ❌ |
| restStatus | - | 需要从vipConfig查询 | ❌ |
| vipStatus | usersSecret[0].vipStatus | 已转换（仅自己） | ⚠️ |
| vipConfig | usersSecret[0].vipConfig | 已转换（仅自己） | ⚠️ |

### 3.4 问题总结

**需要修复的问题**：
1. ❌ **缺少字段**：joinStatus, restStatus（需要从数据库查询）
2. ⚠️ **字段限制**：vipStatus和vipConfig仅在查看自己信息时返回

**建议**：
- 在`GetUserProfile`中补充查询joinStatus
- 从vipConfig中提取restStatus
- 确保字段命名与iOS App模型一致

---

## 四、修复建议

### 4.1 动态数据格式转换

**建议在`dyn.js`中添加数据转换函数**：

```javascript
/**
 * 将核心层返回的动态数据转换为App格式
 */
function convertDynToAppFormat(dyn, currentOpenId) {
  return {
    id: dyn._id,
    userId: dyn.openId || dyn.userInfo?.openId,
    userName: dyn.userInfo?.nickName || '未知用户',
    userAvatar: dyn.userInfo?.avatarVisitUrl || dyn.userInfo?.avatarUrl,
    userSignature: dyn.userInfo?.signature,
    isVip: dyn.userInfo?.usersSecret?.[0]?.vipStatus || false,
    content: dyn.dynContent || '',
    images: dyn.imageList || dyn.imageIds || [],
    tag: null, // 需要从其他字段推导
    publishTime: new Date(dyn.publicTime || dyn.createTime),
    commentCount: dyn.commentNums || 0,
    likeCount: dyn.likeNums || 0,
    shareCount: dyn.forwardNums || 0,
    chargeCount: dyn.chargeNums || 0,
    isLiked: dyn.like && Array.isArray(dyn.like) && dyn.like.includes(currentOpenId),
    isCollected: false, // 需要额外查询
    isCharged: false,  // 需要额外查询
    repostPost: dyn.forwardInfo ? convertRepostInfo(dyn.forwardInfo) : null,
    likeUsers: null,   // 需要额外查询
    joinCount: null,   // 需要额外查询
    circleId: dyn.circleId,
    circleTitle: dyn.circleTitle,
    circleJoinCount: null, // 需要额外查询
    voiceUrl: dyn.dynVoice,
    voiceDuration: dyn.dynVoiceLen,
    videoUrl: dyn.dynVideo,
    musicInfo: dyn.musicId ? {
      musicId: dyn.musicId,
      musicName: dyn.musicName,
      musicAuthor: dyn.musicAuthor,
      musicPoster: dyn.musicPoster,
      musicSrc: dyn.musicSrc,
      isAudioShow: dyn.isAudioShow || false
    } : null
  };
}
```

### 4.2 用户数据格式补充

**建议在`user.js`的`GetUserProfile`中补充字段**：

```javascript
// 查询用户状态
const userResult = await db.collection('user').where({ openId: userId }).get();
const user = userResult.data[0];

// 补充joinStatus和restStatus
profile.joinStatus = user.joinStatus;
profile.restStatus = user.usersSecret?.[0]?.vipConfig?.restStatus || false;
```

---

## 五、优先级

### P0 - 必须修复（阻塞功能）
1. 动态数据格式转换（用户信息提取）
2. 时间格式转换
3. 布尔值判断（isLiked等）

### P1 - 重要修复（影响体验）
1. 转发信息格式转换
2. 多媒体内容URL转换
3. 用户信息补充字段

### P2 - 可选修复（增强功能）
1. 收藏状态查询
2. 充电状态查询
3. 互动用户列表
4. 标签推导

---

## 六、测试建议

1. **单元测试**：测试数据转换函数的正确性
2. **集成测试**：测试完整的数据流
3. **端到端测试**：在真实环境中验证数据格式

---

**文档更新时间**: 2026-01-15
**状态**: 待实施
