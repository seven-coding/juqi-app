# 生产与测试环境检查清单（消息相关）

用 **CloudBase 控制台** 或 **CloudBase MCP** 分别对生产、测试环境做以下三项检查。

---

## 环境 ID

| 环境 | envId |
|------|--------|
| **测试** | `test-juqi-3g1m5qa7cc2737a1` |
| **生产** | `prod-juqi-7glu2m8qfa31e13f` |

---

## 1. 有没有建索引（messagesType）

**集合**：`messagesType`  
**推荐索引**：`to`（升序）、`status`（升序）、`createTime`（降序），名称可为 `to_status_createTime`。

### 控制台

- 云开发控制台 → 选择环境 → 数据库 → 文档数据库 → 集合 `messagesType` → **索引管理**
- 查看是否存在包含 `to`、`status`、`createTime` 的复合索引。

### MCP（若可用）

- 读 NoSQL 数据库结构（或“查询集合索引”）→ 指定 env 与集合 `messagesType` → 看返回的索引列表里是否有上述复合索引。

---

## 2. 是不是最新的云函数

**重点**：`getMessagesNew`、`appApi`（云托管会调 getMessagesNew）。

“最新”以 **JUQI-APP 仓库** 为准：  
- 代码与 `JUQI-APP/cloudfunctions/getMessagesNew/`、`JUQI-APP/cloudfunctions/appApi/` 一致  
- 测试环境应由 `node run-full-deploy.js` 部署。

### 控制台

- 云开发控制台 → 选择环境 → 云函数 → `getMessagesNew` / `appApi` → 查看**最后修改时间**、代码版本（若有版本号）。

### MCP（若可用）

- 获取云函数列表 → 看 `getMessagesNew`、`appApi` 的更新时间或配置  
- 或拉取函数代码与本地 `cloudfunctions/` 对比。

---

## 3. 超时是否修改（getMessagesNew）

**期望**：`getMessagesNew` 执行超时 = **60 秒**（当前本地 `cloudbaserc.json` 为 60）。  
若线上仍为 **10 秒**，会导致 “Invoking task timed out after 10 seconds”。

### 控制台

- 云开发控制台 → 选择环境 → 云函数 → `getMessagesNew` → **函数配置** / **编辑** → 查看 **执行超时时间**（秒）。

### MCP（若可用）

- 查询云函数详情/配置 → 取 `getMessagesNew` 的 `Timeout` 或等效字段，确认是否为 60。

---

## 检查结果记录（可复制填写）

```
【生产 prod-juqi-7glu2m8qfa31e13f】
1. messagesType 索引：有 / 无（索引名：_________）
2. getMessagesNew 是否最新：是 / 否（最后更新：_________）
3. getMessagesNew 超时：_____ 秒

【测试 test-juqi-3g1m5qa7cc2737a1】
1. messagesType 索引：有 / 无（索引名：_________）
2. getMessagesNew 是否最新：是 / 否（最后更新：_________）
3. getMessagesNew 超时：_____ 秒
```

---

## 说明

- 当前会话**没有**可用的腾讯云 CloudBase MCP 工具，无法代你直接查两环境；请在本机用控制台或你本地的 MCP 按上表逐项检查。
- 若超时仍为 10 秒：在**对应环境**把 `getMessagesNew` 改为 60 秒并保存；测试环境也可重新执行 `cd JUQI-APP/cloudfunctions && node run-full-deploy.js` 以同步配置。
