# App接口与现有云函数映射关系

## 一、映射说明

本文档说明App接口与现有云函数的对应关系，用于开发时参考。

**重要架构原则**：
- **版本控制方案**：业务版本层处理所有App特有逻辑，核心层保持纯净
- **参数标准化**：App版本通过Token解析openId，核心层统一接收标准化参数
- **不传递source参数**：核心层不区分调用来源，专注于核心业务逻辑
- **完全隔离**：App和小程序使用不同入口，互不影响

## 二、接口映射表

### 2.1 用户认证类

| App接口 | 现有云函数 | 调用方式 | 说明 |
|---------|----------|---------|------|
| appLogin | login | 版本层封装 | 登录接口，支持微信登录和手机号登录，版本层处理Token生成 |
| appGetUserInfo | login (userinfo) | 版本层封装 | 获取用户信息，返回会员状态，版本层处理数据格式转换 |
| appRefreshToken | login (refresh) | 版本层封装 | 刷新Token，版本层处理Token验证和刷新逻辑 |

### 2.2 用户信息类

| App接口 | 现有云函数 | 调用方式 | 说明 |
|---------|----------|---------|------|
| appGetCurrentUser | login (getOwnInfo) | 版本层封装 | 获取当前用户完整信息，版本层处理会员状态 |
| appGetUserProfile | getUserAbout | 标准化调用 | 获取用户主页信息，版本层传递标准化参数 |
| appUpdateUserInfo | updateUserInfo | 标准化调用 | 更新用户信息，版本层处理参数转换 |
| appGetUserStats | getUserAbout (type=stats) | 标准化调用 | 获取用户统计数据，版本层传递标准化参数 |

### 2.3 动态类

| App接口 | 现有云函数 | 调用方式 | 说明 |
|---------|----------|---------|------|
| appGetDynList | getDynsListV2 | 标准化调用 | 获取动态列表，版本层处理参数标准化和数据格式转换 |
| appGetDynDetail | getDynDetail | 标准化调用 | 获取动态详情，版本层传递标准化参数 |
| appPublishDyn | publishDyn | 标准化调用 | 发布动态，版本层处理参数转换 |
| appDeleteDyn | delDyn | 标准化调用 | 删除动态，版本层传递标准化参数 |
| appLikeDyn | likeOrUnlikeV2 | 标准化调用 | 点赞或取消点赞，版本层传递标准化参数 |
| appCommentDyn | commentV2 | 标准化调用 | 评论动态，版本层传递标准化参数 |
| appGetComments | getDynComment | 标准化调用 | 获取评论列表，版本层传递标准化参数 |

### 2.4 圈子类

| App接口 | 现有云函数 | 调用方式 | 说明 |
|---------|----------|---------|------|
| appGetCircleList | getCircle | 标准化调用 | 获取圈子列表，版本层传递标准化参数 |
| appGetCircleDetail | getCircleDetail | 标准化调用 | 获取圈子详情，版本层传递标准化参数 |
| appJoinCircle | setJoinCircle (type=1) | 标准化调用 | 加入圈子，版本层传递标准化参数 |
| appQuitCircle | setJoinCircle (type=2) | 标准化调用 | 退出圈子，版本层传递标准化参数 |
| appGetCircleMembers | getCircleDetail (members) | 版本层封装 | 获取圈子成员列表，版本层可能需要组合调用 |

### 2.5 消息类

| App接口 | 现有云函数 | 调用方式 | 说明 |
|---------|----------|---------|------|
| appGetMessageList | getMessagesNew | 标准化调用 | 获取消息列表，版本层处理数据格式转换 |
| appGetChatHistory | chat | 标准化调用 | 获取聊天记录，版本层传递标准化参数 |
| appSendMessage | chat (send) | 标准化调用 | 发送私信消息，版本层传递标准化参数 |
| appMarkMessageRead | getMessagesNew (markRead) | 版本层封装 | 标记消息已读，版本层封装业务逻辑 |
| appGetUnreadCount | getMessagesNew (count) | 版本层封装 | 获取未读消息数，版本层封装业务逻辑 |

### 2.6 搜索类

| App接口 | 现有云函数 | 调用方式 | 说明 |
|---------|----------|---------|------|
| appSearchUser | getRearch (type=user) | 标准化调用 | 搜索用户，版本层传递标准化参数 |
| appSearchDyn | getRearch (type=dyn) | 标准化调用 | 搜索动态，版本层传递标准化参数 |
| appSearchTopic | getRearch (type=topic) | 标准化调用 | 搜索话题，版本层传递标准化参数 |

### 2.7 文件上传类

| App接口 | 现有云函数 | 调用方式 | 说明 |
|---------|----------|---------|------|
| appUploadImage | upload | 标准化调用 | 上传图片，版本层传递标准化参数 |
| appDeleteImage | delImage | 标准化调用 | 删除图片，版本层传递标准化参数 |

### 2.8 其他功能类

| App接口 | 现有云函数 | 调用方式 | 说明 |
|---------|----------|---------|------|
| appGetTopicList | getTopic | 标准化调用 | 获取话题列表，版本层传递标准化参数 |
| appGetTopicDetail | getTopic (detail) | 标准化调用 | 获取话题详情，版本层传递标准化参数 |
| appGetConfig | getInfo | 标准化调用 | 获取配置信息，版本层传递标准化参数 |
| appFollowUser | followOrUnfollow (type=1) | 标准化调用 | 关注用户，版本层传递标准化参数 |
| appUnfollowUser | followOrUnfollow (type=2) | 标准化调用 | 取消关注，版本层传递标准化参数 |

## 三、调用方式说明

### 3.1 标准化调用方式（推荐）

对于可以直接映射的接口，版本层将App参数标准化后调用核心层：

```javascript
// ========== 业务版本层（appApi/modules/dyn.js）==========
async function appGetDynList(event) {
  // 1. Token验证，解析openId（App版本特有）
  const { openId } = await verifyToken(event.token);
  
  // 2. 参数标准化（将App参数转为核心层标准格式）
  const coreParams = {
    openId: openId,
    ownOpenId: openId,  // App版本在版本层处理openId
    type: event.data.type,
    page: event.data.page || 1,
    limit: event.data.limit || 20
    // 注意：不传递source参数
  };
  
  // 3. 调用核心层（传递标准化参数）
  const result = await cloud.callFunction({
    name: 'getDynsListV2',
    data: coreParams  // 不包含source
  });
  
  // 4. 数据格式转换（适配App需求）
  return {
    code: 200,
    data: formatAppDynList(result.result),
    message: '成功'
  };
}
```

### 3.2 版本层封装方式

对于需要组合多个云函数或需要额外处理的接口，在版本层封装：

```javascript
// ========== 业务版本层（appApi/modules/message.js）==========
async function appGetUnreadCount(event) {
  // 1. Token验证，解析openId
  const { openId } = await verifyToken(event.token);
  
  // 2. 调用核心层
  const result = await cloud.callFunction({
    name: 'getMessagesNew',
    data: {
      openId: openId,
      ownOpenId: openId,
      type: 'count'
      // 不传递source参数
    }
  });
  
  // 3. 封装返回数据（App特有格式）
  return {
    code: 200,
    data: {
      unreadCount: result.result.count || 0
    },
    message: '成功'
  };
}
```

### 3.3 独立实现方式

对于App有完全不同的业务逻辑的接口，在版本层独立实现：

```javascript
// ========== 业务版本层（appApi/modules/auth.js）==========
async function appLogin(event) {
  // App特有的登录逻辑
  // 直接操作数据库，不调用核心层
  const db = cloud.database();
  
  // App登录业务逻辑
  // ...
  
  // 生成App专用Token
  const token = generateAppToken(userInfo);
  
  return {
    code: 200,
    data: {
      token: token,
      userInfo: formatAppUserInfo(userInfo)
    },
    message: '登录成功'
  };
}
```

## 四、参数标准化说明

### 4.1 参数标准化原则

**核心原则**：版本层负责参数标准化，核心层只接收标准化参数

1. **openId处理**
   - App版本：版本层通过Token解析openId
   - 小程序版本：通过wxContext获取openId
   - 核心层：统一接收openId参数，不关心来源

2. **参数格式统一**
   - 版本层将App参数转换为核心层标准格式
   - 核心层接收统一的参数格式
   - 不传递source参数

### 4.2 参数映射示例

```javascript
// ========== App请求参数 ==========
{
  operation: 'appGetDynList',
  data: {
    type: 'all',
    page: 1,
    limit: 20
  },
  token: 'xxx'
}

// ========== 版本层处理 ==========
// 1. Token验证，解析openId
const { openId } = await verifyToken(event.token);

// 2. 参数标准化
const coreParams = {
  openId: openId,
  ownOpenId: openId,
  type: event.data.type,
  page: event.data.page,
  limit: event.data.limit
  // 不包含source参数
};

// ========== 核心层接收 ==========
// 核心层（getDynsListV2）接收标准化参数
exports.main = async (event, context) => {
  const { openId, ownOpenId, type, page, limit } = event;
  // 核心业务逻辑（不区分来源）
  // ...
}
```

### 4.3 必须标准化的参数

所有调用核心层时，必须标准化以下参数：

- `openId`: 用户openId（版本层通过Token解析）
- `ownOpenId`: 当前用户openId（通常等于openId）
- 业务参数：根据核心层接口要求标准化

**不传递的参数**：
- `source`: 不传递，核心层不区分来源

## 五、响应数据格式化

### 5.1 统一响应格式

所有App接口返回统一格式：

```json
{
  "code": 200,
  "data": {},
  "message": "成功"
}
```

### 5.2 数据转换流程

```javascript
// ========== 核心层返回 ==========
{
  result: {
    list: [...],
    total: 100
  }
}

// ========== 版本层转换 ==========
// 版本层将核心层返回转换为App格式
return {
  code: 200,
  data: {
    list: result.result.list,
    total: result.result.total
  },
  message: '成功'
};
```

### 5.3 数据格式转换示例

```javascript
// 版本层数据转换函数
function formatAppDynList(coreData) {
  return {
    list: coreData.list.map(item => ({
      id: item._id,
      content: item.content,
      images: item.images || [],
      // App特有的字段转换
      // ...
    })),
    total: coreData.total,
    hasMore: coreData.list.length >= 20
  };
}
```

## 六、会员状态处理

### 6.1 会员状态获取

所有返回用户信息的接口，版本层必须确保包含会员状态：

```javascript
// 版本层处理会员状态
async function appGetUserInfo(event) {
  const { openId } = await verifyToken(event.token);
  
  // 调用核心层
  const result = await cloud.callFunction({
    name: 'login',
    data: {
      operation: 'userinfo',
      openId: openId,
      ownOpenId: openId
    }
  });
  
  // 确保返回会员状态（版本层处理）
  return {
    code: 200,
    data: {
      userInfo: {
        ...result.result.userInfo,
        usersSecret: [{
          vipStatus: result.result.vipStatus,
          vipStartTime: result.result.vipStartTime,
          vipEndTime: result.result.vipEndTime,
          vipConfig: result.result.vipConfig
        }]
      }
    },
    message: '成功'
  };
}
```

### 6.2 会员状态同步

- 所有返回用户信息的接口必须包含最新会员状态
- 会员状态从数据库实时获取
- 会员状态字段位置统一：`data.userInfo.usersSecret[0].vipStatus`
- 版本层负责确保会员状态正确返回

## 七、错误处理

### 7.1 错误码映射

版本层统一处理错误，转换为App接口的错误格式：

```javascript
// 核心层可能返回的错误
{
  code: 400,
  message: "参数错误"
}

// 版本层转换为App格式
{
  code: 400,
  message: "参数错误",
  data: null
}
```

### 7.2 错误处理流程

1. 调用核心层
2. 检查返回结果
3. 版本层统一处理错误
4. 返回统一错误格式

```javascript
// 版本层错误处理
try {
  const result = await cloud.callFunction({
    name: 'getDynsListV2',
    data: coreParams
  });
  
  if (result.result.code !== 200) {
    return {
      code: result.result.code,
      message: result.result.message,
      data: null
    };
  }
  
  return formatAppResponse(result.result);
} catch (error) {
  return {
    code: 500,
    message: '服务器错误',
    data: null
  };
}
```

## 八、开发注意事项

### 8.1 版本控制原则

- **版本层处理差异**：所有App特有逻辑在版本层处理
- **核心层保持纯净**：核心层不接收source参数，不区分来源
- **参数标准化**：版本层负责参数标准化，核心层接收标准参数
- **数据格式转换**：版本层负责数据格式转换，适配App需求

### 8.2 隔离保证

- App客户端只调用appApi云函数
- appApi的业务版本层处理所有App特有逻辑
- 调用核心层时传递标准化参数，不传source
- 小程序直接调用现有云函数，不受影响
- 核心层保持纯净，不区分来源

### 8.3 数据一致性

- App和小程序共享数据库
- 核心层使用相同的业务逻辑操作数据
- 确保数据完全一致
- 会员状态字段完全一致

### 8.4 测试验证

- 每个接口开发后都要测试
- 验证参数标准化是否正确
- 验证数据格式转换是否正确
- 验证会员状态同步
- 验证小程序功能未受影响

## 九、版本控制 vs Source判断对比

| 对比项 | Source判断方案 | 版本控制方案（当前） |
|--------|---------------|-------------------|
| **核心层复杂度** | 需要if-else判断 | 保持纯净，无判断 |
| **可维护性** | 每个核心函数都要判断 | 核心层统一标准 |
| **可扩展性** | 新增版本需修改核心层 | 新增版本只需新增版本层 |
| **代码复用** | 部分复用 | 完全复用 |
| **职责清晰度** | 核心层关心来源 | 版本层处理差异，职责清晰 |
| **测试复杂度** | 需要测试不同source分支 | 核心层测试更简单 |

**当前采用版本控制方案，架构更清晰，可维护性更强。**
