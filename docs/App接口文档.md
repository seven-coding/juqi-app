# JUQI App接口文档

## 文档说明

本文档用于记录JUQI iOS App的所有接口定义。接口参数将在开发过程中逐步补充。

**重要架构原则**:
- **版本控制方案**：业务版本层处理所有App特有逻辑，核心层保持纯净
- **完全隔离**：所有App接口通过`appApi`云函数统一入口，与小程序完全隔离
- **参数标准化**：App版本通过Token解析openId，核心层统一接收标准化参数
- **会员状态同步**：所有接口返回的会员状态必须与小程序保持一致

---

## 一、接口架构

### 1.1 架构层次

```
┌──────────────┐
│ iOS App客户端 │  ← 入口层：请求发起
└──────┬───────┘
       ↓
┌──────────────┐
│  appApi入口   │  ← 客户端层：入口/鉴权/参数适配
│  (Token验证)  │     - 统一入口
│  (参数校验)   │     - Token验证
│  (响应格式化) │     - 参数适配
└──────┬───────┘
       ↓
┌──────────────┐
│  业务版本层   │  ← 业务版本层：真正的差异在这里
│  (modules)   │     - App特有的业务逻辑
│  auth/user/  │     - 参数标准化
│  dyn/circle/ │     - 数据格式转换
│  message等   │     - 可独立扩展，不影响小程序
└──────┬───────┘
       ↓
┌──────────────┐
│  业务核心层   │  ← 业务核心层：能共用就共用
│  现有云函数   │     - 核心业务逻辑
│  (login/     │     - 数据库操作
│   getDyns等)  │     - 不区分来源，保持纯净
└──────┬───────┘
       ↓
┌──────────────┐
│  共享数据库   │  ← 数据层：共享数据存储
└──────────────┘
```

### 1.2 接口入口

**云函数名称**: `appApi`

**调用方式**:
```javascript
// iOS App调用示例（使用云开发SDK）
cloud.callFunction({
  name: 'appApi',
  data: {
    operation: '接口名称',
    data: { 接口参数 },
    token: '用户Token' // 需要认证的接口必须携带
  }
}).then(res => {
  // 处理响应
}).catch(err => {
  // 处理错误
});
```

### 1.3 响应格式

**成功响应**:
```json
{
  "code": 200,
  "data": { 数据内容 },
  "message": "成功"
}
```

**失败响应**:
```json
{
  "code": 400/401/403/500,
  "message": "错误信息",
  "data": null
}
```

### 1.4 错误码说明

- `200`: 成功
- `400`: 请求参数错误或业务错误
- `401`: Token无效或未登录
- `403`: 无权限
- `500`: 服务器错误

### 1.5 版本控制实现

**核心原则**：
- 业务版本层（modules）负责处理所有App特有逻辑
- 参数标准化：App版本通过Token解析openId，核心层统一接收标准化参数
- 不传递source参数：核心层不区分调用来源，专注于核心业务逻辑
- 数据格式转换：版本层负责将核心层返回转换为App所需格式

---

## 二、接口分类

### 2.1 用户认证类

#### appLogin - App登录
- **说明**: App用户登录接口，通过微信code获取openId，查询用户状态，生成Token
- **是否需要Token**: 否
- **返回会员状态**: 是
- **实现方式**: 版本层封装，处理App特有登录逻辑和Token生成

**请求参数**:
```javascript
{
  code: String  // 微信授权返回的code（必填）
}
```

**返回数据**:
```javascript
{
  code: 200,
  data: {
    token: String,           // 用户Token
    openId: String,          // 用户openId
    joinStatus: Number,      // 用户状态 (0=待验证, 1=正常, 3=待语音验证, -1=注销, -2=封禁)
    vipStatus: Boolean,       // 是否为VIP会员
    trialStartTime: Number,  // 试用期开始时间（时间戳，毫秒）
    trialDays: Number        // 试用期天数（默认7天）
  },
  message: "成功"
}
```

**错误码**:
- `400`: 缺少code参数或微信授权失败
- `403`: 账号已被封禁或注销
- `500`: 服务器错误

**调用示例**:
```javascript
const result = await cloud.callFunction({
  name: 'appApi',
  data: {
    operation: 'appLogin',
    data: {
      code: '微信授权返回的code'
    }
  }
});
```

#### appGetUserInfo - 获取用户信息
- **说明**: 获取当前登录用户信息
- **是否需要Token**: 是
- **返回会员状态**: 是
- **实现方式**: 版本层封装，处理数据格式转换和会员状态

**请求参数**: 无

**返回数据**:
```javascript
{
  code: 200,
  data: {
    userStatus: {
      joinStatus: Number,      // 用户状态
      vipStatus: Boolean,      // 是否为VIP会员
      trialStartTime: Number,  // 试用期开始时间
      trialDays: Number        // 试用期天数
    }
  },
  message: "成功"
}
```

**会员状态字段位置**: `data.userStatus.vipStatus`

**调用示例**:
```javascript
const result = await cloud.callFunction({
  name: 'appApi',
  data: {
    operation: 'appGetUserInfo',
    token: '用户Token'
  }
});
```

#### appRefreshToken - 刷新Token
- **说明**: 刷新用户Token
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 版本层封装，处理Token验证和刷新逻辑
- **参数**: （开发时补充）
- **返回**: （开发时补充）

---

### 2.2 用户信息类

#### appGetCurrentUser - 获取当前用户信息
- **说明**: 获取当前登录用户的完整信息
- **是否需要Token**: 是
- **返回会员状态**: 是
- **实现方式**: 版本层封装，处理会员状态
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetUserProfile - 获取用户主页信息
- **说明**: 获取指定用户的主页信息（可查看他人主页）
- **是否需要Token**: 是
- **返回会员状态**: 是（仅自己的信息）
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appUpdateUserInfo - 更新用户信息
- **说明**: 更新当前用户信息
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层处理参数转换
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetUserStats - 获取用户统计数据
- **说明**: 获取用户统计数据（发布数、关注数、粉丝数等）
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

---

### 2.3 动态类

#### appGetDynList - 获取动态列表
- **说明**: 获取动态列表，支持多种类型（全部、关注、圈子、话题等）
- **是否需要Token**: 是
- **返回会员状态**: 否（但动态中包含发布者的VIP状态）
- **实现方式**: 标准化调用，版本层处理参数标准化和数据格式转换

**请求参数**:
```javascript
{
  type: String,        // 动态类型: 'all'(全部), 'follow'(关注), 'circle'(圈子), 'topic'(话题)
  page: Number,        // 页码（可选，默认1）
  limit: Number,       // 每页数量（可选，默认20）
  circleId: String,    // 圈子ID（type='circle'时必填）
  topic: String,       // 话题名（type='topic'时必填）
  publicTime: Number   // 分页时间戳（可选，用于加载更多）
}
```

**返回数据**:
```javascript
{
  code: 200,
  data: {
    list: [{
      id: String,              // 动态ID
      userId: String,          // 用户ID
      userName: String,         // 用户名
      userAvatar: String,      // 用户头像
      isVip: Boolean,          // 发布者是否为VIP
      content: String,         // 动态内容
      images: [String],        // 图片列表
      publishTime: Date,       // 发布时间
      commentCount: Number,    // 评论数
      likeCount: Number,       // 点赞数
      shareCount: Number,      // 转发数
      chargeCount: Number,     // 充电数
      isLiked: Boolean,        // 是否已点赞
      // ... 其他字段
    }],
    total: Number,             // 总数
    hasMore: Boolean,           // 是否有更多
    publicTime: Number          // 最后一条动态的时间戳（用于分页）
  },
  message: "成功"
}
```

**调用示例**:
```javascript
const result = await cloud.callFunction({
  name: 'appApi',
  data: {
    operation: 'appGetDynList',
    data: {
      type: 'all',
      page: 1,
      limit: 20
    },
    token: '用户Token'
  }
});
```

#### appGetDynDetail - 获取动态详情
- **说明**: 获取指定动态的详细信息
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appPublishDyn - 发布动态
- **说明**: 发布新动态
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层处理参数转换
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appDeleteDyn - 删除动态
- **说明**: 删除自己发布的动态
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appLikeDyn - 点赞动态
- **说明**: 点赞或取消点赞动态
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appCommentDyn - 评论动态
- **说明**: 对动态进行评论
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetComments - 获取评论列表
- **说明**: 获取动态的评论列表
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

---

### 2.4 圈子类

#### appGetCircleList - 获取圈子列表
- **说明**: 获取圈子列表
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetCircleDetail - 获取圈子详情
- **说明**: 获取指定圈子的详细信息
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appJoinCircle - 加入圈子
- **说明**: 加入指定圈子
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appQuitCircle - 退出圈子
- **说明**: 退出已加入的圈子
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetCircleMembers - 获取圈子成员
- **说明**: 获取圈子的成员列表
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 版本层封装，可能需要组合调用
- **参数**: （开发时补充）
- **返回**: （开发时补充）

---

### 2.5 消息类

#### appGetMessageList - 获取消息列表
- **说明**: 获取消息列表（支持多种消息类型）
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层处理数据格式转换
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetChatHistory - 获取聊天记录
- **说明**: 获取与指定用户的聊天记录
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appSendMessage - 发送消息
- **说明**: 发送私信消息
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appMarkMessageRead - 标记消息已读
- **说明**: 标记消息为已读状态
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 版本层封装，封装业务逻辑
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetUnreadCount - 获取未读消息数
- **说明**: 获取未读消息数量
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 版本层封装，封装业务逻辑
- **参数**: （开发时补充）
- **返回**: （开发时补充）

---

### 2.6 搜索类

#### appSearchUser - 搜索用户
- **说明**: 根据关键词搜索用户
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appSearchDyn - 搜索动态
- **说明**: 根据关键词搜索动态
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appSearchTopic - 搜索话题
- **说明**: 根据关键词搜索话题
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

---

### 2.7 文件上传类

#### appUploadImage - 上传图片
- **说明**: 上传图片文件
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appDeleteImage - 删除图片
- **说明**: 删除已上传的图片
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

---

### 2.8 其他功能类

#### appGetTopicList - 获取话题列表
- **说明**: 获取话题列表
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetTopicDetail - 获取话题详情
- **说明**: 获取指定话题的详细信息
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appGetConfig - 获取配置信息
- **说明**: 获取App配置信息
- **是否需要Token**: 否
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appFollowUser - 关注用户
- **说明**: 关注指定用户
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

#### appUnfollowUser - 取消关注
- **说明**: 取消关注指定用户
- **是否需要Token**: 是
- **返回会员状态**: 否
- **实现方式**: 标准化调用，版本层传递标准化参数
- **参数**: （开发时补充）
- **返回**: （开发时补充）

---

## 三、会员状态说明

### 3.1 会员状态字段

会员状态包含以下字段：
- `vipStatus`: Boolean - 是否为会员
- `vipStartTime`: Number - 会员开始时间（时间戳，毫秒）
- `vipEndTime`: Number - 会员结束时间（时间戳，毫秒）
- `vipConfig`: Object - 会员配置信息

### 3.2 会员状态位置

在返回用户信息的接口中，会员状态位于：
- `data.userInfo.usersSecret[0].vipStatus`
- `data.userInfo.usersSecret[0].vipStartTime`
- `data.userInfo.usersSecret[0].vipEndTime`
- `data.userInfo.usersSecret[0].vipConfig`

### 3.3 会员状态同步

- 所有返回用户信息的接口必须包含最新会员状态
- 会员状态必须从服务器实时获取，不能依赖本地缓存
- 会员状态判断逻辑与小程序完全一致
- 版本层负责确保会员状态正确返回

---

## 四、接口开发优先级

### 第一阶段（核心功能）
1. appLogin - 登录
2. appGetUserInfo - 获取用户信息
3. appGetDynList - 获取动态列表
4. appGetDynDetail - 获取动态详情
5. appPublishDyn - 发布动态
6. appLikeDyn - 点赞
7. appCommentDyn - 评论

### 第二阶段（重要功能）
8. appGetCircleList - 圈子列表
9. appGetCircleDetail - 圈子详情
10. appJoinCircle - 加入圈子
11. appGetMessageList - 消息列表
12. appSendMessage - 发送消息
13. appSearchUser - 搜索用户

### 第三阶段（辅助功能）
14. 其他接口根据需求逐步实现

---

## 五、注意事项

1. **版本控制架构**: 所有App接口通过appApi云函数，业务版本层处理差异，核心层保持纯净
2. **参数标准化**: App版本通过Token解析openId，核心层统一接收标准化参数，不传递source参数
3. **会员状态**: 所有返回用户信息的接口必须包含会员状态，版本层负责确保正确返回
4. **Token管理**: 需要认证的接口必须携带有效Token
5. **错误处理**: 统一错误码和错误信息格式
6. **数据一致性**: 确保App和小程序数据完全一致

---

## 六、文档更新记录

- 2025-01-11: 创建接口文档框架，确定接口范围和分类
- 2025-01-11: 更新为版本控制架构方案，去掉source参数判断

---

**说明**: 接口的具体参数和返回值将在开发过程中逐步补充完善。
