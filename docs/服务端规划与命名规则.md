# 服务端规划与命名规则（AI 用）

> 高信息密度、规则化描述，便于 AI 理解本仓库服务端规划与版本号含义。

## 阶段规划

| 阶段 | 含义 |
|------|------|
| **第一期** | 用一套新云函数（v201）开发 App；只有 App 走 v201，小程序继续用旧函数。 |
| **第二期** | 小程序全部迁到 v201，改调 v201。 |
| **最终** | 废弃旧函数，完成重构。 |

## 命名规则

- **v201**：本仓库维护的「新版」云函数集合，供 App 使用。云端函数名、本地目录名、代码内互调名统一为 xxxV201（如 appApiV201、getDynsListV201、commonRequestV201）。
- **旧函数（无后缀或 V2 等）**：线上已有，供小程序使用。本仓库**不部署、不修改、不删除**旧函数；部署仅针对 v201 列表，故**不影响小程序**。

## 本仓库约定

- **身份**：本仓库 = App 后端，只部署、只维护 v201 云函数。
- **配置**：cloudbaserc（正式/测试）中函数列表均为 xxxV201；正式与测试仅 envId 不同，函数名一致。
- **部署**：deployNameToDir 为部署名即目录名（如 getDynDetailV201、getMessagesNewV201），本地目录与云端函数名一一对应，均为 xxxV201。
- **运行时**：getFuncName、getPublishDynCallName、commonRequest 调用名、apiServer 调用的云函数名一律为 v201，不按环境区分 V2/V201。
- **本地目录**：已全部与 v201 对齐（getDynDetailV201、getMessagesNewV201、setMessageV201、chargeHerV201 等），无「无后缀」旧目录。

## 当前决策

- **测试环境**：App 以 apiServer 直连为主。以下 7 个 operation **固定走直连**，由代码内 `DIRECT_DB_OPERATIONS` 决定，不按环境变量按接口切换；其余 operation 走 appApiV201。
- **回滚**：仅保留「全局回滚到全云函数」开关（`USE_CLOUD_FUNCTION_FALLBACK` 或 POST `/app/v2/migration/fallback`），用于故障应急。

## v2 直连与云函数对应

| 类型 | 说明 |
|------|------|
| **直连实现（仅以下 7 个）** | appGetCurrentUserProfile、appGetDynList、appGetDynDetail、appChargeDyn、appGetUnreadCount、appGetMessageList、appGetChatList；实现位置在 apiServer 各 module（user/dyn/message）及 app.service handleDirectDBRequest；直连由 `DIRECT_DB_OPERATIONS` 固定，不再通过 MIGRATION_* 配置。 |
| **走 appApiV201 云函数** | appLikeDyn、appSetMessage、appMarkMessagesRead 等其余 operation 均走 appApiV201 云函数。 |
| **测试环境部署清单** | 测试环境使用 cloudbaserc.test.json，其中**不包含** getDynDetailV201、getMessagesNewV201、likeOrUnlikeV201、setMessageV201；依赖这些子云函数的 App 能力在测试环境通过上述 7 个直连接口实现（列表/详情/充电/消息等），不依赖未部署子云函数。 |

## 约束摘要

1. 部署只操作 v201 函数列表，不碰旧函数。
2. 代码内互调、apiServer 调用云函数，统一使用 v201 名。
3. 环境仅通过 envId/cloudbaserc 区分测试/正式，不通过函数名区分。
4. 若某环境缺某云函数，在该环境内单独实现/部署，不跨环境调用。
