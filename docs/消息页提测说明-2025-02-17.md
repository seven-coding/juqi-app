# 消息页（含申请/私信对话）提测说明

**日期**: 2025-02-17  
**范围**: 消息 Tab 全流程（分类列表、会话详情、申请列表、对话页拉取与发送）  
**环境**: 仅测试环境（JUQI-APP 云函数 + 测试数据）

---

## 一、部署前必做（测试环境可用）

1. **部署云函数 appApiV201**
   - 方式：使用 **Cloudbase MCP**（先 `mcp_cloudbase_login` 选择测试环境），再 `updateFunctionCode`。
   - 路径：`functionRootPath` 为 JUQI-APP 目录的**绝对路径**（即 cloudfunctions 的父目录），函数名 `appApiV201`。
   - 说明：本次新增 `appSendChatMessage`（对话页发送）、已有 `appGetChatMessages`（对话页拉取），均在同一云函数内。

2. **确认测试环境**
   - 测试环境 ID 以 `cloudbaserc.json` / `cloudbaserc.test.json` 为准；仅部署 JUQI-APP 的云函数，不部署小程序侧云函数。

---

## 二、功能检查清单（可提测范围）

| 序号 | 功能点 | 说明 | 预期 |
|------|--------|------|------|
| 1 | 消息 Tab 入口 | 底部 Tab「消息」 | 进入消息首页，展示 4 个分类 + 申请 |
| 2 | 分类列表 | 评论/充电/@我/访客/申请 | 各分类展示对应 type 列表，未读角标正确（申请角标暂可为 0） |
| 3 | 会话详情（非对话） | 点击 type 16/17 或 groupId==6 等 | 只读列表，无输入框；点击某条可跳转动态/用户 |
| 4 | 申请列表 | 申请 Tab → type 10 列表 | 展示申请类消息；点击 type 20–23 进入对话页 |
| 5 | 对话页拉取 | 进入申请/私信对话页 | 展示 messageChat 历史（type 20–23），气泡左右区分本人/对方 |
| 6 | 对话页发送 | 输入内容点发送 | 调用 appSendChatMessage 成功，输入框清空，列表刷新后出现新消息 |
| 7 | 查看/回复 | 评论/充电/@我 等「查看」「回复」 | 查看→动态/用户；回复→进入对应会话详情或对话页 |
| 8 | onShow 刷新 | 切出再回到消息 Tab | 未读数/列表在 onAppear 时刷新 |

---

## 三、接口依赖（测试环境）

- **拉取对话消息**: `operation: "chat"` → 映射到 `appGetChatMessages`（appApiV201）。
- **发送对话消息**: `operation: "appSendChatMessage"`（appApiV201）。
- 以上请求均需携带有效 Token（登录态）。

---

## 四、已知限制与后续优化

- 申请 Tab 未读数：若后端未在未读汇总中返回申请未读数，前端申请角标保持 0。
- 发送失败：目前失败时仅恢复输入框内容，可后续增加 Toast 提示。
- 实时推送：当前无 WebSocket/推送，新消息需下拉刷新或再次进入对话页可见。

---

## 五、自测建议

1. 使用测试环境账号登录，确认消息列表、未读角标正常。
2. 进入一条「申请/私信」对话，先下拉刷新确认历史，再发一条新消息，确认列表刷新且新消息在下方、本人气泡在右侧。
3. 从申请列表进入对话、从「回复」进入会话详情，各跳转正确无 404。

完成上述部署与清单检查后，可交付 QA 提测。
