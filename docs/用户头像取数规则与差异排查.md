# 用户头像取数规则与 App/小程序差异排查

## 一、数据库字段含义

| 字段 | 含义 | 写入时机 |
|------|------|----------|
| **avatarUrl** | 用户头像原始地址 | 注册/登录或更新头像时写入，可能是 `cloud://` 或 微信头像等 https |
| **avatarVisitUrl** | 头像的「可访问 HTTPS 缓存」 | 仅当用户通过 **updateUserInfo** 上传 **cloud://** 头像时，云函数调用 `getTempList` 生成临时 https 后写入 |

因此：**只有上传过 cloud 头像的用户才有 avatarVisitUrl**；微信头像或历史只存了 avatarUrl 的用户，avatarVisitUrl 可能为空。

---

## 二、各端取数方式对比

### 1. 后端/云函数取数优先级（一致）

以下位置均使用 **avatarVisitUrl 优先、其次 avatarUrl**：

- **JUQI-APP/cloudfunctions/appApi/modules/user.js**
  - `convertDynToAppFormat`：`userAvatar: userInfo.avatarVisitUrl || userInfo.avatarUrl || null`
  - `GetCurrentUserProfile`：`avatarUrl = userInfo.avatarVisitUrl || userInfo.avatarUrl || null`
  - `GetUserProfile`：`avatar: userData.avatarVisitUrl || userData.avatarUrl || userData.avatar`
  - `GetUserList`：`avatar: user.avatarVisitUrl || user.avatarUrl || null`
- **JUQI-小程序/cloudfunctions/appApi/modules/user.js**
  - `appGetUserList`：`avatar: user.avatarVisitUrl || user.avatarUrl || null`
- **getDynsListV2/dealData.js（APP 与小程序）**
  - lookup user 时 `userLimit` 均包含 `avatarUrl: 1` 与 `avatarVisitUrl: 1`，返回的 `userInfo[0]` 两个字段都有；后续若某处只读一个字段则可能不一致。

### 2. 差异点 1：APP 广场列表未查 avatarVisitUrl

**文件：** `JUQI-APP/cloudfunctions/getDynsListV2/getSquareList.js`

```javascript
.field({
  openId: true,
  avatarUrl: true,   // 只查了 avatarUrl
  nickName: true,
  avatarHat: true,
  // 未包含 avatarVisitUrl
})
```

- **结果**：广场列表中的用户头像只来自 **avatarUrl**，即使用户表里有 **avatarVisitUrl** 也不会被使用。
- **表现**：同一用户在「个人页/关注列表等（用 appApi 或 dealData）」与「广场列表」在 App 上可能不一致（个人页有临时 https，广场仍是 cloud 或旧地址）。

### 3. 差异点 2：小程序前端头像组件只用 avatarUrl

**文件：** `JUQI-小程序/miniprogram/components/avatar/index.js`

- 组件展示头像时**只使用 `data.avatarUrl`**，**未使用 `data.avatarVisitUrl`**：

```javascript
'data': function(data) {
  if (data && data.avatarUrl && data.avatarUrl.includes('cloud://prod-juqi-...')) {
    const newAvatar = data.avatarUrl.replace('cloud://...', 'https://7072-prod-juqi-...');
    this.setData({ source: newAvatar });
  } else if (data && data.avatarUrl) {
    this.setData({ source: data.avatarUrl });
  }
}
```

- **结果**：即然后端/云函数返回了 `avatarVisitUrl`，小程序列表/详情里的头像仍只按 **avatarUrl** 显示；且 cloud 替换写死为**生产环境**域名。
- **表现**：若某用户主要可访问头像是 avatarVisitUrl（https），而 avatarUrl 为空或为旧图，小程序会不显示或显示旧图，与 App 或接口数据不一致。

### 4. 差异点 3：cloud:// 转 HTTPS 的域名不一致

- **小程序**：前端写死把 `cloud://prod-juqi-7glu2m8qfa31e13f...` 换成 `https://7072-prod-juqi-7glu2m8qfa31e13f-1314478640.tcb.qcloud.la`（生产域名）。
- **APP**：云函数侧用 `convertCloudUrlToHttps` / `getTempFileURL`，依赖**当前云环境**（测试环境则生成测试环境域名）。
- **结果**：同一 `cloud://` 文件，在 App 测试环境与小程序生产环境可能解析到不同域名，若再叠加「有的地方用 avatarUrl、有的用 avatarVisitUrl」，会出现部分一致、部分不一致。

---

## 三、为何「部分一致、部分不一致」

| 场景 | 一致原因 | 不一致原因 |
|------|----------|------------|
| 同一用户在多处展示 | 都来自 user 表，且若只存在 avatarUrl、两端都只用 avatarUrl 时 | 有的接口/前端用 avatarVisitUrl||avatarUrl，有的只用 avatarUrl；或广场未查 avatarVisitUrl |
| 同一用户 App vs 小程序 | 若都只用到 avatarUrl，且都能正常显示 | 小程序组件只用 avatarUrl；App 部分接口用 avatarVisitUrl；cloud 转 https 域名不同（prod vs test） |
| 有的用户一致、有的不一致 | 只有 avatarUrl 的老用户，两端都展示 avatarUrl | 有 avatarVisitUrl 的用户：App 用临时 https，小程序仍用 avatarUrl（或未展示） |

---

## 四、修复建议（仅改 App 侧，符合 v2 隔离）

1. **APP getSquareList 与 dealData 统一带上 avatarVisitUrl，且展示时与 user 模块一致**
   - 在 `getSquareList.js` 的 `.field()` 中增加 `avatarVisitUrl: true`。
   - 格式化 `userInfo` 时，头像使用 `avatarVisitUrl || avatarUrl`，与 appApi/user 一致；若当前列表在 App 端还会经一层 URL 转换，保持对 cloud 的转换逻辑即可。

2. **小程序端（已做）**
   - `JUQI-小程序/miniprogram/components/avatar/index.js`：展示头像时改为使用 `data.avatarVisitUrl || data.avatarUrl`，与后端取数规则一致。

3. **数据与缓存**
   - 确保测试环境 user 表里，有头像的用户在 `updateUserInfo` 时同时写入 `avatarUrl` 与 `avatarVisitUrl`（当前逻辑是 cloud 才写 avatarVisitUrl，可保持）；若发现历史用户缺少 avatarVisitUrl，可考虑按需回填或在前端/接口层统一降级为 avatarUrl。

---

## 五、修改清单

- [x] **JUQI-APP getDynsListV2/getSquareList.js**：`.field()` 增加 `avatarVisitUrl: true`，构造 `userInfo` 时头像使用 `avatarVisitUrl || avatarUrl`，与 appApi 一致。
- [x] **JUQI-小程序 miniprogram/components/avatar/index.js**：`data` 的 observer 中头像展示改为 `data.avatarVisitUrl || data.avatarUrl`，与后端取数规则一致。
