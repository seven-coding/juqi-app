# 前端连接测试环境并开始测试

## 方式一：本地 apiServer + 测试环境云函数（推荐，直接开始测试）

前端连本地 apiServer，apiServer 连测试环境云函数 `test-juqi-3g1m5qa7cc2737a1`，无需部署云端接口即可联调。

### 1. 配置 apiServer 环境变量

在 `JUQI-APP/apiServer` 下创建 `.env`（不要提交到仓库）：

```bash
# 使用测试环境
NODE_ENV=test

# 云开发凭证（调用云函数用）
CLOUD_BASE_ID=你的SecretId
CLOUD_BASE_KEY=你的SecretKey

# 测试环境 ID（已部署 appApi 等）
TCB_ENV_TEST=test-juqi-3g1m5qa7cc2737a1
TCB_ENV_PROD=prod-juqi-7glu2m8qfa31e13f

PORT=9999
```

### 2. 启动 apiServer（测试环境）

```bash
cd JUQI-APP/apiServer
npm install
npm run start:test
```

看到 `App API Server (v2) is running on port 9999` 和 `[CloudbaseService] Initialized - env: test-juqi-3g1m5qa7cc2737a1` 即表示已连测试环境。

### 3. 前端使用本地接口

- **iOS App**：`AppConfig.swift` 中已默认开启本地测试：
  - `useLocalTestAPI = true` → 请求 `http://localhost:9999/app/v2/api`
  - 模拟器：保持 `testLocalHost = "localhost"`
  - 真机：改为你电脑的局域网 IP，如 `testLocalHost = "192.168.1.100"`
- 使用 **DEBUG** 编译运行 App，即可直接请求本地 apiServer，apiServer 会调用测试环境云函数。

### 4. 开始测试

- 在 Xcode 中 Run（DEBUG），打开 App 进行登录、动态等操作。
- 终端中可看到 apiServer 的请求与云函数调用日志。

---

## 方式二：前端连云端测试地址

若测试环境已部署云托管（如 `https://test-api.juqi.life`）：

1. 在 `AppConfig.swift` 中关闭本地接口：`useLocalTestAPI = false`
2. DEBUG 下会使用 `https://test-api.juqi.life/app/v2/api`
3. 无需本地跑 apiServer，直接 Run App 即可。

---

## 环境与接口对应关系

| 前端环境 | useLocalTestAPI | API 地址 | apiServer 需运行 |
|----------|-----------------|----------|-------------------|
| DEBUG + 本地 | true（默认） | http://localhost:9999/app/v2/api | 本地 `npm run start:test` |
| DEBUG + 云端 | false | https://test-api.juqi.life/app/v2/api | 云端已部署 |
| RELEASE | - | https://api.juqi.life/app/v2/api | 生产云托管 |

---

## 常见问题

- **真机无法访问 localhost**：把 `testLocalHost` 改为电脑局域网 IP，并确保手机和电脑在同一 WiFi。
- **apiServer 报错缺少云开发凭证**：检查 `.env` 中 `CLOUD_BASE_ID`、`CLOUD_BASE_KEY` 是否正确。
- **云函数报错**：确认测试环境 `test-juqi-3g1m5qa7cc2737a1` 已部署 appApi（可用 MCP 或控制台部署）。
