# 消息模块架构分析与优化 — 遗留事项

基于 [消息模块架构分析与优化_849a6f5a.plan.md](/.cursor/plans/消息模块架构分析与优化_849a6f5a.plan.md) 与当前代码对照，已做完的见计划内 P0/P1/P2 实施记录，此处仅列**未完成或待确认**项。

---

## 一、部署与线上生效（需你侧确认）

| 项 | 说明 | 状态 |
|----|------|------|
| getMessagesNew 超时 60s | 本地 cloudbaserc.json 已为 60s，若**实际被调用的环境**未重新部署，线上仍可能是 10s（日志已出现 “timed out after 10 seconds”） | **需在 prod/test 环境确认并部署** |
| messagesType 复合索引 | 文档已写 (to, status, createTime)；需在**生产 + 测试**两环境确认是否已建 | **需在控制台/MCP 确认** |
| 云函数是否为最新 | setMessage（openId + dataEnv）、getMessagesNew（去重 circle lookup）、appApi（错误 reason）等是否已部署到当前 Cloud Run 使用的环境 | **需确认部署** |

详见 [生产与测试环境检查清单.md](JUQI-APP/docs/生产与测试环境检查清单.md)。

---

## 二、P1 未完全落地

| 项 | 计划建议 | 当前状态 |
|----|----------|----------|
| getMessagesUser 聚合优化 | 「先分页取 id 再按 id 批量查详情，减少单次聚合体积」 | **已做**：先 match+sort+skip+limit 取一页，再并行批量查 circle/messagesUser/dyn/user，内存拼装。 |

---

## 三、P2 / 体验与运维 未做或待加强

| 项 | 计划建议 | 当前状态 |
|----|----------|----------|
| 首屏请求策略 | 首屏「仅首次加载 + 下拉刷新」，tab 切回不自动再请求 | **已做**：hasLoadedOnce 控制，仅首次或 refresh() 时请求。 |
| 超时与错误态 UI | 对 433/5xx 做统一错误态与**重试入口** | **已做**：loadFailed + MessageLoadFailedView（首屏与各分类页均有重试）。 |
| 空态区分 | 按分类（充电/评论/艾特/访客）区分空态文案 | **已有**：各分类页文案已区分。 |
| 批量已读 | MarkMessagesRead 传 dataEnv；客户端可调批量接口 | **已做**：appApi MarkMessagesRead 传 dataEnv；APIService 增加 markMessagesRead(messageIds, mesType)。 |

---

## 四、小结

- **必须先解决**：部署与线上生效（超时 60s、索引、最新云函数），否则消息接口会持续超时。
- **可选优化**：P1 聚合「先分页 id 再查详情」；P2 首屏策略、错误态/重试、空态文案、批量已读（视产品优先级排期）。
