# 消息页数据链路排查与修复（测试环境读线上数据）

## 问题现象

- 使用**测试环境云函数**、在 App 内选择「**线上数据**」时，**消息页没有数据**。
- 期望：测试环境部署的云函数能够按用户选择读取**线上库**的消息数据。

## 数据链路（修复前）

1. **客户端**：消息页通过 `APIService.getMessages()` → `NetworkService.request(operation: "getMessagesNew", data: ...)`，请求体已带 `dataEnv`（来自 `AppConfig.dataEnv`，设置页可切换「测试数据/线上数据」）。
2. **入口**：请求发往测试环境 **appApi** 云函数；appApi 将 `getMessagesNew` 映射为 `appGetMessageList`，并按 `dataEnv` 初始化了 **event.db**（可为 prod 或 test）。
3. **问题点**：`appApi/modules/message.js` 的 **GetMessageList** 没有使用 event.db，而是通过 `cloud.callFunction({ name: 'getMessagesNew', data: coreParams })` 调用核心层，且 **coreParams 未传 dataEnv**。
4. **核心层**：**getMessagesNew** 使用 `cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })` 和 `cloud.database()`，即**固定使用当前云函数所在环境**（测试环境）的数据库，无法读线上库。

**根因**：getMessagesNew 未支持按 dataEnv 切换数据库环境，且 appApi 未把 dataEnv 传给 getMessagesNew。

## 修复方案

### 1. getMessagesNew 支持 dataEnv

- **入口**（`getMessagesNew/index.js`）：在 `main` 第一行根据 `event.dataEnv` 切换环境并注入 db：
  - `dataEnv === 'prod'` 时 `cloud.init({ env: PROD_ENV_ID })`，否则 `TEST_ENV_ID`。
  - `global.__GETMESSAGESNEW_DB__ = cloud.database()`，供子模块使用。
- **子模块**（getMessagesUser、operate、getVisitMessage、getCommentLike、getCommonMes、getFollowMessage、getAitMes、getUserInfo 等）：在各自**异步函数内部**通过 `getDb()` 取 db：`const db = global.__GETMESSAGESNEW_DB__ || (cloud.init(), cloud.database())`，保证在 appApi 传入 dataEnv 时使用正确环境的数据库。

### 2. appApi 传递 dataEnv

- **appApi/modules/message.js**：
  - **GetMessageList**：从 event 取 `dataEnv`，写入 `coreParams.dataEnv`，再调用 `getMessagesNew`。
  - **GetUnreadCount**：同样将 `dataEnv` 传入 getMessagesNew。

### 3. 客户端

- 已确认：`NetworkService` 请求体包含 `dataEnv: AppConfig.dataEnv`，设置页切换「线上数据」后为 `prod`，无需改动。

## 修复后链路

1. 用户在设置页选择「**线上数据**」→ `AppConfig.dataEnv = "prod"`。
2. 消息页请求 appApi，body 含 `operation: "getMessagesNew"`（映射为 appGetMessageList）、`dataEnv: "prod"`。
3. appApi 根据 dataEnv 初始化环境，并将 **dataEnv 传入 GetMessageList**。
4. GetMessageList 将 **dataEnv 写入 coreParams** 并 `callFunction('getMessagesNew', coreParams)`。
5. getMessagesNew 入口根据 **dataEnv=prod** 执行 `cloud.init({ env: PROD_ENV_ID })`，设置 `global.__GETMESSAGESNEW_DB__`，子模块通过 getDb() 使用该 db，从而查询**线上库**消息。

## 涉及文件

- `cloudfunctions/getMessagesNew/index.js`：入口 dataEnv 初始化与 global 注入。
- `cloudfunctions/getMessagesNew/getMessagesUser.js`、`operate.js`、`getVisitMessage.js`、`getCommentLike.js`、`getCommonMes.js`、`getFollowMessage.js`、`getAitMes.js`、`getUserInfo.js`：函数内通过 getDb() 使用当前环境 db。
- `cloudfunctions/appApi/modules/message.js`：GetMessageList、GetUnreadCount 向 getMessagesNew 传递 dataEnv。

## 部署与验证

- 部署测试环境云函数：在 **JUQI-APP/cloudfunctions** 下执行 `node run-full-deploy.js`（需包含 appApi、getMessagesNew）。
- 验证：App 设置页选「线上数据」，进入消息页，应能看到线上消息列表；选「测试数据」则仍读测试库。

---

## 补充修复：消息 tab 不请求 + 二级页无数据（2025-02）

### 现象

1. 进入消息 tab 没有发起接口请求、无相关日志。
2. 进入二级 tab（如充电列表）请求返回 200、hasData: true，但列表无数据（实际有数据）。

### 原因与修复

**1. 消息 tab 不请求**

- **原因**：首屏若曾返回空数据（如缓存或首次未带 token），会设 `allLoaded = (0 >= 0) = true`，之后 `loadMessages()` 被 `guard !allLoaded` 拦截，不再请求；且消息接口默认走缓存，可能一直用旧空数据。
- **修复**：
  - `MessageViewModel`：仅在「有总数且已拿满」时置 `allLoaded`，即 `allLoaded = response.count > 0 && processedMessages.count >= response.count`，避免空结果把后续请求挡掉。
  - `APIService.getMessages`：增加 `useCache: false`，消息列表不再用缓存，每次进入/刷新都会请求。

**2. 充电列表等二级页“有接口无数据”**

- **原因**：云函数 `getMessagesNew` 的 type 约定为 3=充电、4=评论、5=访客、11=艾特；`ChargeMessageView` 误用 `messageType: 5`（访客），导致请求的是访客消息而非充电消息，列表为空。
- **修复**：`ChargeMessageView` 改为 `messageType: 3`（充电）。`CommentMessageView`(4)、`VisitorMessageView`(5)、`AtMessageView`(11) 已正确。
- 同时：`MessageCategoryViewModel` 的请求加上 `useCache: false`，且 `allLoaded` 与 `MessageViewModel` 同逻辑，避免空结果锁死后续加载。
