# 降本分析 · 数据采集产出

采集时间：执行数据采集计划当日。数据来源：tccli、Node 统计脚本、Cloudbase MCP。

---

## 一、账单（tccli DescribeBillSummary）

### 2025-12 月（RealTotalCost，单位：元）

| 产品 | 金额 |
|------|------|
| 云开发 | 10,090.87 |
| 内容分发网络 CDN | 1,483.88 |
| COS 对象存储 | 548.78 |
| 短信 SMS | 496.50 |
| 数据万象 CI | 447.06 |
| 云数据库 Redis | 189.24 |
| 其他 | 0 |

### 2025-11 月（对比）

| 产品 | 金额 |
|------|------|
| 云服务器 CVM | 2,529.84 |
| 云开发 | 2,091.19 |
| 内容分发网络 CDN | 384.16 |
| 数据万象 CI | 139.02 |
| COS 对象存储 | 72.59 |
| 短信 SMS | 50.00 |
| 轻量应用服务器 | 40.00 |
| 云数据库 Redis | 19.00 |

**结论**：12 月云开发较 11 月高约 8,000 元（含企业版 9,590 元等）；CDN、短信、COS、数据万象、Redis 在 12 月均有明显升高，需控制台补查用量原因。

---

## 二、用户与 NoSQL（脚本 count-inactive-and-deleted-users.js）

环境：**生产** `prod-juqi-7glu2m8qfa31e13f`。

| 指标 | 数值 | 说明 |
|------|------|------|
| 用户总数 | 33,235 | user 集合 |
| 已注销（joinStatus=-1） | 327 | 0.98% |
| 封禁（joinStatus=-2） | 99 | — |
| 2 年未活跃（joinStatus=1 且 realEnterTime&lt;2年前） | 17,371 | 52.27% |
| **可清理目标合计（注销+2年未活跃）** | **17,698 人** | **约 53.3%** |
| **优质帖子数（userTopTime&gt;0 或 likeNums≥10 或 commentNums≥5）** | **486,216** | 清理 dyn 时保留，不删 |
| dyn 总量 | 2,079,126 | — |
| user_followee | 95,428 | — |
| messagesOther | 8,926,467 | — |
| messagesType | 66,638 | — |
| messagesUser | 411,650 | — |
| dynComments | 640,382 | — |
| user_secret | 26,350 | — |

**说明**：优质帖子约占总 dyn 的 23.4%；清理时只删「可清理用户」的**非优质** dyn 及关联数据，不删 user 文档。

---

## 三、云函数（Cloudbase MCP getFunctionList）

环境：**测试** `test-juqi-3g1m5qa7cc2737a1`。共 **22** 个云函数，Runtime 均为 Nodejs16.13。

| 函数名 | 状态 |
|--------|------|
| appApiV201、getDynsListV201、getDynDetailV201、publishDynV201、likeOrUnlikeV201、delDynV201、getMessagesNewV201、setMessageV201、getCircleV201、getCircleDetailV201、getTopicV201、setTopicV201、setJoinCircleV201、getRearchV201、loginV201、commonRequestV201、getUserAboutV201、chargeHerV201、setUserV201、updateUserInfoV201、getUserListV201、setUserInfoV201 | 21 个 Active |
| chargeHerV201 | **UpdateFailed**（zip 为空，需修复部署） |

**待补采（控制台）**：各函数近 30 天调用次数、错误数、平均耗时、GBs，用于识别低频与直连替代收益。

---

## 四、云托管（Cloudbase MCP queryCloudRun）

服务：**juqi-api-server**（环境：测试 `test-juqi-3g1m5qa7cc2737a1`）。

| 配置项 | 值 |
|--------|-----|
| ServerType | container |
| Cpu | 0.5 核 |
| Mem | 1 GB |
| MinNum | 1 |
| MaxNum | 10 |
| 扩缩容策略 | cpu 60%、mem 60% |
| 访问类型 | PUBLIC、MINIAPP、OA |
| 默认域名 | https://juqi-api-server-217941-7-1314478640.sh.run.tcloudbase.com |

**优化方向**：测试环境可评估 MinNum=0（闲时缩容到 0）；生产环境需在控制台查看对应服务配置与 QPS 后决定是否缩容。

**待补采（控制台）**：生产环境云托管配置（若与测试分离）、近 7 日 QPS/请求量。

---

## 五、待控制台补采项

| 数据项 | 用途 | 建议路径 |
|--------|------|----------|
| 云函数各函数调用量/错误/耗时/GBs（近 30 天） | 直连与收口节约估算 | 云开发控制台 → 云函数 → 各函数 → 监控/统计 |
| NoSQL 总存储（GB）、月读/写出次数 | 数据清理节约估算 | 云开发控制台 → 生产环境 → 数据库 → 概览或监控 |
| 云开发费用细分（企业版、云函数、NoSQL、存储等） | 节约金额换算 | 费用中心 → 账单详情 或 云开发控制台 → 套餐与计费 |
| 生产环境云托管配置与 QPS | 生产缩容决策 | 云托管 → 生产环境对应服务 → 实例与监控 |
| CDN/短信/COS/数据万象 12 月用量明细 | 异常月原因与限流 | 各产品控制台用量报表 |

---

## 六、复现命令

```bash
# 账单（需先配置 tccli）
bash JUQI-APP/scripts/configure-tccli.sh
/Users/tongyao/Library/Python/3.9/bin/tccli billing DescribeBillSummary --Month 2025-12 --GroupType business

# 用户与 NoSQL 统计（需 CLOUD_BASE_ID/CLOUD_BASE_KEY）
cd JUQI-APP/cloudfunctions && node scripts/count-inactive-and-deleted-users.js
```

云函数列表与云托管详情：通过 Cloudbase MCP 的 getFunctionList、queryCloudRun 获取（当前为测试环境）。
