# 2025 年腾讯云账单与优化分析

基于 `tccli billing DescribeBillSummary --GroupType business` 按产品维度汇总，数据日期：查询执行日。

---

## 一、2025 年各月费用概览（按产品，单位：元）

| 月份 | 云开发 | CDN | 数据万象CI | CVM | 轻量 | 短信 | COS | Redis | MySQL | 其他 |
|------|--------|-----|------------|-----|------|------|-----|-------|-------|------|
| 01 | 2460.38 | 531.53 | 214.10 | - | 85.00 | 50.00 | 48.90 | - | - | - |
| 02 | 2285.47 | 468.49 | 172.38 | - | 85.00 | 50.00 | 47.51 | - | - | - |
| 03 | 4410.05 | 505.02 | 198.57 | - | 85.00 | - | 54.82 | 19.00 | - | - |
| 04 | 1344.29 | 356.29 | 151.30 | 254.00 | 43.71 | 50.00 | 54.78 | 19.00 | - | 域名33 |
| 05 | 2095.05 | 429.03 | 176.10 | 254.00 | 45.00 | 50.00 | 59.94 | 19.00 | - | CLS1.2 |
| 06 | 909.82 | 409.01 | 160.47 | 254.00 | 80.00 | 50.00 | 60.33 | 19.00 | - | CLS1.0 |
| 07 | 1967.27 | 303.75 | 141.19 | 762.00 | 54.03 | - | 64.40 | 19.00 | - | - |
| 08 | 1881.52 | 364.99 | 141.14 | - | 45.00 | 50.00 | 66.88 | 19.00 | 331.60 | - |
| 09 | 2121.25 | 322.42 | 127.74 | - | 45.00 | 50.00 | 66.51 | 19.00 | - | - |
| 10 | 2073.77 | 271.07 | 121.65 | 254.00 | 40.00 | - | 70.29 | 19.00 | - | - |
| 11 | 2091.19 | 384.16 | 139.02 | 2529.84 | 40.00 | 50.00 | 72.59 | 19.00 | - | - |
| 12 | **10090.87** | **1483.88** | **447.06** | - | - | **496.50** | **548.78** | **189.24** | - | - |

---

## 二、2025 年各产品合计与占比（估算）

| 产品 | 全年合计（元） | 占比（约） | 说明 |
|------|----------------|------------|------|
| **云开发 (TCB)** | **34,130** | **65%** | 云函数、云托管、NoSQL、云存储等，JUQI-APP 主用 |
| 内容分发网络 CDN | 6,233 | 12% | 静态资源/图片加速 |
| 数据万象 CI | 2,190 | 4% | 图片处理 |
| 云服务器 CVM | 4,308 | 8% | 部分月份有高额（7 月 762、11 月 2529） |
| 轻量应用服务器 | 648 | 1% | 包月/按量 |
| 短信 SMS | 947 | 2% | 12 月异常升高（496） |
| COS 对象存储 | 817 | 1.5% | 12 月 548 明显升高 |
| 云数据库 Redis | 380 | 0.7% | 12 月 189 升高 |
| 云数据库 MySQL | 332 | 0.6% | 仅 8 月有 |
| 域名注册 / 日志 CLS 等 | 35 | - | 零星 |
| **合计** | **约 52,000** | 100% | 含四舍五入 |

---

## 三、12 月费用排查结论（账单明细核对）

已用 `tccli billing DescribeBillDetail --Month 2025-12` 分页拉取 12 月明细，结论如下。

### 3.1 云开发 12 月约 10,090 元 — 根因

| 明细项 | 金额（元） | 资源 ID / 说明 |
|--------|------------|----------------|
| **云开发平台企业版** | **9,590.40** | **prod-juqi-7glu2m8qfa31e13f**（生产环境） |
| 云开发资源费用 - 云资源 | 约 350+ | prod-juqi-7glu2m8qfa31e13f，多笔 37.42 / 17.42 |
| 云开发资源费用 - 容量资源包 | 138.00 | pkg-mkjkbash、pkg-djxycrlk 各 69.00 |

- **结论**：12 月云开发费用主要由 **「云开发平台企业版」月费 9,590.40 元** 构成，对应 **生产环境**，属套餐/企业版固定费用，并非当月用量暴增。
- **建议**：在 [云开发控制台](https://console.cloud.tencent.com/tcb) → 选择环境 prod-juqi-7glu2m8qfa31e13f → 查看「套餐与计费」：若 12 月新购/升级了企业版，可评估是否降级或改按量；若为企业版包年/包月，可确认续费周期与是否必要保留该档位。

### 3.2 其他 12 月异常（CDN / 短信 / COS / Redis）

- **CDN 1,484、短信 496、COS 549、数据万象 447、Redis 189**：账单明细中 12 月前若干页以「云开发」「CDN 流量」「短信套餐」「COS 存储/流量」等分散条目出现，未在本次分页中逐条汇总到单产品。
- **建议**：在控制台按 12 月时间范围分别查看：CDN 流量与带宽、短信发送记录、COS 存储量与外网下行、数据万象调用量、Redis 连接数/容量，确认是否有活动、爬虫或配置变更导致用量突增，并设置用量/费用告警。

---

## 四、异常与趋势（概览）

1. **12 月费用激增**
   - 云开发：10,090 → **根因已明确为「云开发平台企业版」9,590 元（生产环境）**，见上文第三节。
   - CDN：1,484（较常态约 300–500 高约 3 倍）
   - 短信：496（较常态 50 高约 10 倍）
   - COS：549（较常态约 60–70 高约 8 倍）
   - 数据万象 CI：447（较常态约 120–170 高约 2–3 倍）
   - Redis：189（较常态 19 高约 10 倍）
   - **建议**：云开发见 3.1；其余在控制台按 12 月查看用量并做告警与限流。

2. **云开发月度波动**
   - 3 月 4,410、6 月 910、12 月 10,090，波动大。
   - 与请求量、云函数调用量、云托管实例数/规格、NoSQL 读写、存储流量相关，需结合监控排查。

3. **CVM 仅在部分月出现且金额大**
   - 4–7 月、10–11 月有 254–762；11 月 2,529。
   - 若为临时扩容或测试机，建议用毕关机/缩容或改用更小规格/按量计费优化。

---

## 五、可优化项（按项目与账单对应）

### 1. 云开发（优先级最高，约 34,130 元/年）

- **扩大 apiServer 直连、减少云函数调用**  
  在云托管环境变量中开启：`MIGRATION_DYN_LIST=true`、`MIGRATION_USER_PROFILE=true`、`MIGRATION_UNREAD_COUNT=true`、`MIGRATION_MESSAGE_LIST=true`、`MIGRATION_CHAT_LIST=true`（与现有业务兼容前提下），列表/详情/用户/消息等走直连，可显著降低云函数调用与 GBs。
- **云托管 (juqi-api-server)**  
  - 测试环境：最小实例数设为 0（允许缩容到 0），降低闲时成本。  
  - 生产环境：按实际 QPS 调小实例规格或最小实例数，避免长期满配。
- **云函数**  
  - 仅部署真正在用的函数；未使用的可从测试环境下线。  
  - 超时仅对确有需要的设为 60s，其余保持 30s，减少按量计费。
- **NoSQL**  
  为高频查询（如 dyn、messagesType、messagesUser）建好索引，减少慢查询与读放大；测试环境数据量控制为最小可测即可。
- **云存储**  
  控制测试环境文件量；对可 CDN 的静态资源走 CDN，减少直连存储流量。

### 2. CDN（约 6,233 元/年）

- 在控制台查看带宽/流量 Top 域名与 URL，确认是否有多余域名或异常爬虫。
- 为静态资源设置合理缓存与回源策略，减少回源与重复流量。
- 若 12 月 spike 为活动或一次性活动，可为活动域名做限流/封禁异常 UA。

### 3. 数据万象 CI（约 2,190 元/年）

- 查看图片处理调用量（缩放、裁剪、水印等），去除不必要的处理或合并请求。
- 对可缓存的处理结果走 CDN，减少重复处理。

### 4. 云服务器 CVM（约 4,308 元/年）

- 确认 11 月 2,529、7 月 762 对应实例用途；若为临时或测试，用毕关机或释放。
- 长期开的实例：评估是否可改为更小规格或按量计费+闲时关机。

### 5. 短信（约 947 元/年）

- 12 月 496 异常高，查发送记录与业务（验证码、营销、通知），是否存在刷接口或配置错误导致滥发。
- 对验证码做频率限制与同一手机/同一业务限流。

### 6. COS / Redis

- COS：12 月 548 与存储量、外网下行、请求次数有关，查控制台用量明细；测试环境定期清理无用文件。
- Redis：12 月 189 与连接数、容量、QPS 有关，确认是否为业务增长还是临时调大未缩回。

### 7. 监控与告警

- 为云开发、CDN、短信、COS 设置「用量/费用」告警（按日或周），异常 spike 可及时排查。
- 每月用 `tccli billing DescribeBillSummary --Month yyyy-mm --GroupType business` 做一次核对，与控制台用量对照。

### 8. 数据清理与留存（注销 + 长期未活跃）

**生产环境具体数据（脚本 `cloudfunctions/scripts/count-inactive-and-deleted-users.js` 查询结果）**

| 指标 | 数值 | 说明 |
|------|------|------|
| 用户总数 | 33,235 | 生产环境 user 集合 |
| 已注销（joinStatus=-1） | 327 | 0.98% |
| 封禁（joinStatus=-2） | 99 | — |
| **2 年未活跃（joinStatus=1 且 realEnterTime&lt;2年前）** | **17,371** | **52.27%** |
| **可清理目标合计（注销+2年未活跃）** | **17,698 人** | **约 53.3%** |

关联集合当前总量（生产）：dyn 2,079,110、user_followee 95,428、messagesOther 8,926,378、messagesType 66,638、messagesUser 411,649、dynComments 640,377、user_secret 26,350。

**能节约多少？**

- **定性结论**：可清理目标约 **1.77 万用户（占 53%）**，体量很大。清理其 user 及关联的 dyn / user_followee / messages* / dynComments / user_secret 等文档后，NoSQL 存储与读写出会明显下降。
- **粗估**：若这批用户关联文档量按人数占比约 40–50% 计，则清理后存储与部分读写出可降约 **40–50%**。你当前云开发月费中「企业版」固定费占大头，**存储+读写出**占比若在 10–20%，则整体云开发月费大致可降约 **数个百分点到十个百分点**（例如 5–15%）；若后续降级企业版或改为按量，节省会更明显。
- **建议执行顺序**：先只清理 **已注销 327 人** 的关联数据（风险小、合规易说清）；再对 **2 年未活跃 1.74 万人** 制定归档/清理策略（可分批、可先归档再删），并在控制台观察清理前后 NoSQL 存储与读写出变化，反推实际节约金额。
- **复现统计**：在项目根目录下执行 `cd JUQI-APP/cloudfunctions && node scripts/count-inactive-and-deleted-users.js`，需已配置 `apiServer/.env` 或 `cloudfunctions/.env` 中的 `CLOUD_BASE_ID`/`CLOUD_BASE_KEY`（或 `TENCENT_SECRET_*`），脚本连接生产环境 NoSQL。

**其它类似建议**

- **过期/无效数据**：登录态、临时 token、会话表等设 TTL 或定时清理，避免无限增长。
- **冷数据与归档**：对历史消息、很久以前的动态等制定保留策略（如 1–2 年后只留统计或归档到廉价存储），减少热库体积与读写出。
- **测试环境**：测试库仅保留最小可测数据集，用 [seed-test-collections.js](../cloudfunctions/scripts/seed-test-collections.js) 等定期重置或清理，避免与生产等量膨胀。
- **云存储**：定期清理废弃头像、临时上传、已删除动态的图片/视频引用，减少 COS 存储与流量。
- **执行注意**：清理前务必备份或确认合规（如用户协议、隐私政策中的保留期限）；建议先只读统计、再小批量删除并观察，避免误删活跃用户数据。

---

## 六、建议执行顺序

1. **立即**：云托管开启全部已实现的 MIGRATION_* 直连；测试环境云托管最小实例数改为 0（若业务允许）。
2. **本周**：云开发 12 月根因已确认为「云开发平台企业版」月费 9,590 元（生产环境），在控制台 → 该环境 → 套餐与计费 评估是否降级或改按量；另查 12 月 CDN、短信、COS、Redis 用量明细，加限流/告警。
3. **本月**：CVM 高额月份对应实例用途梳理，临时机用毕关机或缩容。
4. **数据清理**：按「五、8」先统计 注销（joinStatus=-1）与 2 年未活跃 用户数及关联文档量，再制定清理/归档策略并小批量执行，观察存储与读写出变化以反推节约金额。
5. **持续**：每月用 tccli 或控制台对账，形成「账单 ↔ 资源 ↔ 配置」闭环。

---

## 七、分析优化可从哪几方面做（速查）

| 方面 | 关注点 | 典型动作 |
|------|--------|----------|
| 费用 | 产品/时间/资源级费用 | 账单汇总 + 明细 + 异常月/异常资源 |
| 用量 | 调用量、流量、存储、请求数 | 控制台用量报表 + Top 资源 |
| 架构与选型 | 直连 vs 云函数、实例与套餐 | 直连迁移、缩容、降档/改按量 |
| 配置与性能 | 超时、规格、索引、缓存、限流 | 调参、建索引、加限流 |
| 使用模式与异常 | 谁在用、是否爬虫/活动/误用 | 查日志与统计、加防护 |
| 治理与闭环 | 告警、对账、审批 | 设告警、每月对账、规范变更 |

---

## 八、复现查询命令

```bash
# 按产品汇总某月
tccli billing DescribeBillSummary --Month 2025-12 --GroupType business

# 如需按项目/地域等维度
tccli billing DescribeBillSummary --Month 2025-12 --GroupType project
tccli billing DescribeBillSummary help --detail
```

配置 tccli 使用项目密钥：`bash scripts/configure-tccli.sh`（从 `apiServer/.env` 读取 `CLOUD_BASE_ID` / `CLOUD_BASE_KEY`）。直连开关见 [apiServer README](../apiServer/README.md) 与 [环境变量配置说明](../apiServer/环境变量配置说明.md)。
