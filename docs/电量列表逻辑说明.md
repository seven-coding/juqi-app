# 电量列表逻辑说明

## 1. 业务含义

- **电量**：用户给帖子/用户「充电」（点赞/打赏）产生的计数，表示「受喜欢的程度」。
- **电量列表**：展示「谁给当前用户（或某用户）充了电」的流水，即**收到的充电记录**。
- 入口：个人页/他人主页的「电量」数字 → 点击进入 `ChargeListView`。

## 2. 数据流

```
App: ChargeListView
  → APIService.getChargeList(userId: page: limit:)
  → 请求 operation: appGetChargeList, data: { userId, page, limit }

appApi (user.js) GetChargeList
  → 将 userId 解析为 openId（支持 _id/openId）
  → 调用云函数 getUserList，data: { openId: targetOpenId, type: 'charging', page, limit }

getUserList (getUserList/index.js)
  → type === 'charging' 时调用 getCharging(event, ownOpenId)

getCharging (getUserList/getCharging.js)
  → 查 messagesOther 表：to = ownOpenId（被充电的人）, type = 1, chargeType = 2
  → 按 createTime 倒序、分页
  → lookup user 表（from → openId）得到 userInfo
  → 顺带把这类消息的 status 置为 1（已读）
  → 返回 { userList, page, limit, count, type }
```

## 3. 核心数据来源

| 项目 | 说明 |
|------|------|
| 集合 | `messagesOther` |
| 条件 | `to` = 被查看用户 openId，`type` = 1，`chargeType` = 2 |
| 含义 | 「发给 to 的、类型为充电」的消息记录 |
| 排序 | `createTime` 倒序 |
| 关联 | `from` lookup `user.openId` → `userInfo`（充电者昵称、头像等） |

每条记录表示：**谁（from）在什么时间给 to 充了电**；列表即「给 to 充电的流水」。

## 4. 客户端展示

- **ChargeListView**：分页列表，每项为 `ChargeItem`。
- **ChargeItem**：来自 `messagesOther` 单条 + lookup 的 userInfo；字段映射包括：
  - `id` ← `_id`
  - `userId` ← `from`（充电者 openId）
  - `userName` / `avatar` / `signature` ← `userInfo[0]`
  - `chargeTime` ← `createTime`
  - `chargeNums` / `dynId` / `post` 等若接口有则展示。

## 5. 与 dataEnv 的关系

- appApi 的 GetChargeList 使用 event 里的 `db`（由 dataEnv 决定是测试库还是生产库）。
- **resolveUserIdToOpenId** 用该 db 解析 userId → openId。
- **getUserList** 由云函数默认环境决定读哪个库；若 App 传 dataEnv=prod，需确保 getUserList 所在环境或后续改造支持按 dataEnv 读生产库，否则电量列表仍可能是测试库数据。

## 6. 已做修复（与本逻辑相关）

- **appApi**：支持 `data.userId` 与 `data.openId`，统一解析为 targetOpenId；返回使用核心层 `userList` 与 `count`（兼容 `list`/`total`）。
- **App**：请求参数改为传 `userId`（与 appApi 一致），便于查看他人主页时的电量列表正确按人查。

---

## 7. 其它列表修复（关注/粉丝/收藏/拉黑等）

以下修改已统一处理，避免「假数据」或空列表：

| 接口 | 修改点 |
|------|--------|
| **appGetUserList**（关注/粉丝） | 支持 `data.userId` 或 `data.openId`；本身用 `event.db` 查，dataEnv=prod 时即生产库。 |
| **appGetChargeList**（电量） | 返回用 `userList`/`count`；支持 `userId`/`openId`。 |
| **appGetBlackList**（拉黑） | 返回用 `userList`/`count`；支持 `userId`/`openId`；错误判断仅当 `res.code !== 200`。 |
| **appGetFavoriteList**（收藏） | 对 `dynList` 做 `convertDynToAppFormat` + `convertDynListUrls`，与用户动态一致；传 `envId` 以便 dataEnv=prod 时读生产库。 |
| **appGetUserDynList** | 传 `event.envId` 给核心层，dataEnv=prod 时读生产库。 |

**客户端**：关注/粉丝/拉黑请求统一传 `userId`（不再传 `openId`），与 appApi 约定一致。

**说明**：电量列表、拉黑列表当前仍通过云函数 `getUserList` 拉取，该云函数未支持 `envId`，因此在 dataEnv=prod 时可能仍读测试库；若需这两类列表也读生产库，需在 appApi 内对 dataEnv=prod 时用 `event.db` 自查 `messagesOther`/`user_black` 并组 list，或为 `getUserList` 增加 envId 支持。
