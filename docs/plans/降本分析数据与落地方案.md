# 降本分析思路与数据驱动的落地方案（完善版）

**说明**：本文档仅用于完善方案与共识，**不执行任何数据删除、配置变更或上线操作**；具体执行前需单独评审与批准。

---

## 一、分析原则：什么算「不影响现有用户体验」

- **「现有用户」**：非注销（joinStatus≠-1）、非封禁（joinStatus≠-2），且近期有活跃（如 2 年内有 realEnterTime）。
- **「不影响体验」**：只动「已无用户」或「富余资源」——清理目标用户的**数据**（不删用户账号本身）、缩配测试环境、直连替代云函数、限流防刷等；不删/改活跃用户数据，不降低其可用性与延迟。

---

## 二、数据清理的三大约定（完善）

### 2.1 不删除用户，只删除用户的数据

- **不删**：`user` 集合中的用户文档**不删除**，保留用户身份（便于合规、审计与「该账号曾存在」的追溯）。
- **只删**：目标用户（注销 + 2 年未活跃）的**关联数据**，包括：
  - dyn（见下「优质帖子保留」规则后再删）、dynComments、dynFavorite、dynCommentReplay 等与 dyn 相关；
  - user_followee、user_black、user_no_see、blackList；
  - messagesOther、messagesType、messagesUser、messageChat、chatIds；
  - user_secret、shopBP、shopLog（若按 openId 归属）；
  - 其他按 openId 归属且与「身份」无强绑定的业务数据。
- **可选**：对目标用户在 `user` 中的记录做脱敏或仅保留最小字段（如 openId、joinStatus、注销时间），其余字段清空或置为默认值，在「不删用户」前提下减少敏感信息留存。

### 2.2 优质帖子需要保留

- **原则**：即使用户属于「可清理目标」（注销或 2 年未活跃），其发布的**优质帖子**不删除，仅删除非优质内容与其它关联数据。
- **「优质帖子」定义**（满足任一即保留）：
  - **用户置顶**：`dyn.userTopTime > 0`（用户个人主页置顶，与 [appApiV201/modules/dyn.js](../../cloudfunctions/appApiV201/modules/dyn.js) 中 isPinned 一致）；
  - **圈子/话题置顶**：若 dyn 或业务存在 `topTime` 等圈子/话题置顶标记，则保留；
  - **互动阈值**：`likeNums >= N` 或 `commentNums >= M`（N、M 由产品确定，例如 N=10、M=5，用于保留高互动内容）；
  - **产品精选**：若后续在 dyn 或其它表中增加「精选」「推荐」等标记字段，则带标记的帖子一律保留。
- **清理 dyn 时的逻辑**：对目标用户（openId 在可清理列表内）的 dyn，先筛出「优质帖子」集合，**只删除「非优质」的 dyn**；优质帖子及其评论等可保留，或仅做脱敏（如作者名改为「已注销用户」）由产品决定。

### 2.3 数据通过 CLI 获取

- **账单与费用**：统一通过 **tccli** 获取，便于复现与脚本化：
  - 按产品汇总：`tccli billing DescribeBillSummary --Month yyyy-mm --GroupType business`
  - 明细：`tccli billing DescribeBillDetail --Month yyyy-mm`（可分页）
  - 配置：使用项目内 [scripts/configure-tccli.sh](../../scripts/configure-tccli.sh)（从 apiServer/.env 读取密钥）
- **云开发用量与配置**：
  - 优先使用 **腾讯云 CLI / 云开发 CLI（tcb）** 或 **Open API** 拉取：云函数调用次数/错误/耗时、云托管实例与规格、NoSQL 存储与读写出等（具体命令以腾讯云/云开发当前文档为准，在方案中补充 CLI 命令或 API 示例）。
  - 若某指标仅支持控制台查看，则在「需获取的数据」中注明「仅控制台」并写出控制台路径，便于人工补数。
- **用户与 NoSQL 统计**：现有 [count-inactive-and-deleted-users.js](../../cloudfunctions/scripts/count-inactive-and-deleted-users.js) 为 Node + @cloudbase/node-sdk 脚本，视为「本地可复现的数据获取」；若需严格 CLI，可后续补充通过云开发 REST/API 或 tccli 调用统计的示例（若有官方支持）。

### 2.4 先不处理，只完善方案

- 当前阶段**仅完善方案文档**，不执行任何删除、配置变更或上线。
- 执行前需：数据采集完成 → 方案评审 → 批准后再按「建议执行顺序」分步实施。

---

## 三、数据采集计划（执行顺序与方式）

| 序号 | 数据项 | 执行方式 | 产出 |
|------|--------|----------|------|
| 1 | 账单：近月按产品汇总与云开发明细 | `tccli billing DescribeBillSummary --Month 2025-12 --GroupType business`；`DescribeBillDetail --Month 2025-12` 取前几页 | 月度费用表、云开发子项金额 |
| 2 | 用户与 NoSQL：用户总数、注销/2年未活跃、各集合总量、优质帖子数 | 在 `cloudfunctions` 下执行 `node scripts/count-inactive-and-deleted-users.js`（脚本内增加优质帖子计数） | JSON 数字、可写入采集结果文档 |
| 3 | 云函数列表、云托管服务与配置 | Cloudbase MCP：getFunctionList；queryCloudRun list + detail | 函数清单、juqi-api-server 规格与 MinNum/MaxNum |
| 4 | 云函数调用量/耗时、NoSQL 存储与读写出 | 云开发控制台（无统一 CLI 时） | 注明「见控制台」及路径，后续人工补数 |

**说明**：先执行 1～3，将结果写入 [数据采集产出-降本分析.md](../数据采集产出-降本分析.md)；第 4 项为控制台补采，在产出文档中留表待填。

---

## 四、要获取的数据（按模块，获取方式以 CLI 优先）

| 模块 | 数据项 | 用途 | 获取方式 |
|------|--------|------|----------|
| 用户与 NoSQL | 用户总数、注销数、2年未活跃数 | 可清理人数与占比 | 已有脚本；复现见 [2025年腾讯云账单与优化分析.md](../2025年腾讯云账单与优化分析.md) 第八节 |
| 用户与 NoSQL | 可清理用户关联文档数（dyn/messages*/dynComments 等按 openId 统计） | 算准可删文档量 | 扩展脚本或 CLI/API（见上 2.3） |
| 用户与 NoSQL | 优质帖子数量（userTopTime>0 或 likeNums/commentNums 达阈值） | 排除后实际可删 dyn 量 | 脚本查询 dyn 集合条件计数 |
| 用户与 NoSQL | NoSQL 总存储（GB）、月读/写出次数 | 节约量 × 单价 | 云开发 CLI/API 或控制台（注明来源） |
| 云函数 | 各函数近 30 天调用次数、错误数、耗时、GBs | 识别低频/可直连 | 云开发 CLI 或控制台 |
| 云函数 | 云函数在云开发费用中的占比或金额 | 节约金额换算 | tccli 账单明细 + 控制台费用分析 |
| 云托管 | 生产/测试实例规格、MinNum/MaxNum、QPS | 是否可缩容、MinNum=0 | 云开发 CLI 或控制台 |
| 存储/CDN | 云存储容量、外网下行；CDN 流量 Top | 清理与缓存策略 | 控制台或对应产品 CLI（若有） |
| 账单 | 云开发各子项（企业版、云函数、NoSQL、存储）费用与单价 | 节约金额 = 节约用量 × 单价 | tccli DescribeBillDetail + 计费说明 |

---

## 五、落地方案（基于数据，且遵守「只删数据、保留用户与优质帖」）

| 方向 | 依赖数据 | 落地方案 | 节约估算思路 |
|------|----------|----------|--------------|
| **数据清理** | 可清理用户数（已有）、其关联文档数、优质帖子定义下的可删 dyn 数、NoSQL 存储与读写出 | 只删目标用户的**关联数据**，**不删 user**；删 dyn 时**排除优质帖子**（userTopTime>0 或互动达阈值等）；先 327 注销再分批 2 年未活跃 | 可删文档占比 × 当前 NoSQL 存储/读写出 × 单价；或清理前后用量差 × 单价 |
| 直连全覆盖 | 各云函数调用量、当前 MIGRATION_* 状态 | 生产/测试 MIGRATION_* 全开，列表/消息/用户等走直连 | 云函数调用与 GBs 下降 × 单价 |
| 云托管缩容 | 实例规格、MinNum、QPS | 测试 MinNum=0；生产在保证延迟前提下调小规格或 MinNum | 减少的实例·时 × 单价 |
| 云函数收口 | 各函数调用与错误率 | 下线测试环境未用函数；合并低频；超时仅必要项 60s | 减少的调用/GBs × 单价 |
| 企业版/套餐 | 当前套餐与 12 月 9,590 元明细 | 控制台评估降级或改按量（保证生产 SLA） | 固定月费差或按量后预估 |

---

## 六、节约金额估算方法（不变）

1. **用量类**：节约金额 ≈ 节约用量 × 单价（单价从 tccli 账单明细或计费说明获取）。
2. **包月/固定费**：节约金额 = 当前月费 − 调整后月费。
3. **数据清理**：可删文档占比（扣除优质帖子后）→ 可删存储与读写出占比 → × 当前 NoSQL 存储/读写费用或单价；若企业版占大头，再换算为整体月费下降比例。

---

## 七、建议执行顺序（与数据采集结合）

1. **先采数**：按「三」用 CLI（及必要时的控制台）拉取云函数、云托管、NoSQL、账单等；扩展脚本统计「可清理用户关联文档数」与「优质帖子数量」。
2. **无风险项**：直连全开、测试 MinNum=0、下线测试环境未用云函数。
3. **数据清理**：先 327 人关联数据（不删 user、dyn 排除优质）；再分批 2 年未活跃，同规则；观察存储与读写出变化反推节约。
4. **闭环**：每次优化后记录优化前/后用量与费用，更新 [2025年腾讯云账单与优化分析.md](../2025年腾讯云账单与优化分析.md)。

---

## 八、小结

- **不删用户**：只删其关联数据；user 保留，可选脱敏。
- **优质帖子保留**：dyn 满足 userTopTime>0 或互动阈值或产品精选标记的不删。
- **数据用 CLI 拿**：账单用 tccli；云开发用量与配置优先 CLI/API，否则注明控制台路径。
- **当前仅完善方案**：不执行任何变更；执行前单独评审与批准。
