# 帖子详情页完善 - 设计与范围

**日期**：2025-02-11  
**目标**：在现有 PostDetailView 基础上，按《帖子详情页功能对比与开发计划》《版本与进度》的 P1 项，先做**错误态与重试**、**下拉刷新失败反馈**的小闭环，与电站/话题详情页体验一致。

---

## 一、现状与范围澄清

**当前已具备**：用户信息区、圈子信息区、帖子内容（含转发 repostPost 展示）、互动区、评论列表与输入、底部栏、更多操作菜单（分享/举报/删除/收藏/置顶/拉黑）、下拉刷新 `.refreshable`、话题/@ 跳转、长按复制。`loadDetail()` 失败时仅 `print`，无用户可见错误态；下拉刷新失败同样无提示。

**本期完善范围**（仅 App 端，仅改 JUQI-APP，测试环境）：

1. **错误态与重试**：`loadDetail()` 或 `.refreshable` 内请求失败时，展示错误信息 +「重试」按钮，与 CircleDetailView / TopicDetailView 的 errorMessage + 重试一致。
2. **下拉刷新失败反馈**：刷新失败时清空或保留原数据，并设置同一错误态，用户可点重试再次拉取。

**不纳入本期**（YAGNI / 需单独排期）：P0 评论列表与评论输入联调；转发内容展示（UI 已有，若接口未返回 repostPost 则属后端）；关注按钮、更多操作菜单（已实现）；话题/@ 跳转完善（已有 navigationDestination）。

**成功标准**：帖子详情页在拉取详情失败或下拉刷新失败时，用户能看到明确错误提示和「重试」按钮；点击重试能重新请求并更新界面。

---

## 二、方案与取舍

| 项 | 方案 A | 方案 B | 推荐 |
|----|--------|--------|------|
| 错误展示位置 | 顶部 Banner | 内容区上方/替换为错误卡片 | **B**：与话题/电站详情一致，内容区上方错误卡片 + 重试 |
| 刷新失败行为 | 仅 toast | 设置 errorMessage，同首屏失败 | **B**：统一错误态，可重试 |
| 首屏 loadDetail 失败 | 保留列表带来的 post，不显示错误 | 显示错误 + 重试，保留当前 post 预览 | **B**：用户知情且可重试 |

---

## 三、设计要点（分节）

### 3.1 错误态与重试

- 在 `PostDetailView` 中新增 `@State private var errorMessage: String? = nil`。
- 在 `loadDetail()` 的 `catch` 中（排除 `CancellationError`）：`await MainActor.run { errorMessage = error.localizedDescription }`（或统一用「加载失败，请重试」文案）。
- 在 body 中：当 `detailPost != nil` 且 `errorMessage != nil` 时，在 `ScrollView` 内顶部（用户信息区上方）展示错误卡片：背景色与现有 EmptyStateView 一致、文案 `errorMessage`、主按钮「重试」；点击重试清空 `errorMessage` 并调用 `await loadDetail()`。
- 成功路径：`loadDetail()` 成功时在 `await MainActor.run` 内设 `errorMessage = nil`。

**验证**：断网或模拟接口失败进入详情页，应看到错误卡片与重试；点击重试后再次请求，成功则错误消失。

### 3.2 下拉刷新失败反馈

- `.refreshable { ... }` 内保持现有逻辑：`await loadDetail()` 与 `commentListRefreshTrigger = UUID()`。
- `loadDetail()` 内已有对失败时设置 `errorMessage` 的修改后，刷新失败会自动展示同一错误态；无需在 refreshable 内单独 toast，保持与 3.1 一致。

**验证**：进入详情页后下拉刷新，若此时请求失败，应出现错误卡片与重试，且当前已展示的帖子内容仍保留。

### 3.3 首屏与 task 行为

- 保持 `.task` 中先 `detailPost = post; isLoading = false` 再 `await loadDetail()`，避免白屏。
- 若 `loadDetail()` 失败，不再仅 print，而是设置 `errorMessage`，用户看到的是「有内容 + 顶部错误卡片 + 重试」。

**验证**：同 3.1，首屏拿列表的 post 展示，详情请求失败时出现错误卡片与重试。

---

## 四、技术栈与约束

- **技术栈**：SwiftUI，JUQI-APP/juqi（iOS），现有 `APIService.getDynDetail`、`getCurrentUserProfile`、`getUserFollowStatus` 不变。
- **约束**：仅改 App 端；不修改云函数；不引入新依赖；错误样式与 `TopicDetailView` / `CircleDetailView` 的 errorMessage 区域一致（可复用或抄写同一风格）。

---

## 五、确认

若以上范围与设计无异议，将进入**实现计划**（细粒度步骤 + 验证方式），再按 TDD/小步实现并自检收尾。  
若希望本期一并包含「评论联调」或「转发内容接口验收」，请直接说明，可追加到实现计划中。
