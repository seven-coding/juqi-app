# 帖子详情页完善 - 实现计划

**目标**：帖子详情页拉取失败或下拉刷新失败时展示错误信息与「重试」按钮，与话题/电站详情页体验一致。  
**架构**：仅改 `PostDetailView.swift`，复用现有 `EmptyStateView` 风格（或同风格错误卡片）。  
**技术栈**：SwiftUI，iOS App（JUQI-APP/juqi）。

---

## 步骤 1：增加错误态状态与 loadDetail 内赋值

- **文件**：`JUQI-APP/juqi/juqi/Views/Details/PostDetailView.swift`
- **修改**：
  1. 新增 `@State private var errorMessage: String? = nil`。
  2. 在 `loadDetail()` 的 `do` 成功分支里，`await MainActor.run` 中设 `errorMessage = nil`。
  3. 在 `loadDetail()` 的 `catch` 中（排除 `CancellationError`）：`await MainActor.run { errorMessage = error.localizedDescription }`；若希望文案统一，可设为 `errorMessage = "加载失败，请重试"`。
- **验证**：暂无 UI 展示，仅状态与赋值正确；可断点或 print 确认失败时 errorMessage 被设置。

---

## 步骤 2：在内容区上方展示错误卡片与重试

- **文件**：`JUQI-APP/juqi/juqi/Views/Details/PostDetailView.swift`
- **修改**：
  1. 在 `ScrollView { VStack { ... } }` 的 `VStack` 最顶部，当 `errorMessage != nil` 时，先展示错误区块：复用 `EmptyStateView(icon: "wifi.exclamationmark", title: "加载失败", message: errorMessage ?? "", actionTitle: "重试", action: { errorMessage = nil; Task { await loadDetail(); commentListRefreshTrigger = UUID() } })`，或同风格紧凑卡片（文案 + 重试按钮），上下留 padding。
  2. 确保仅当 `detailPost != nil` 时进入该 ScrollView 分支（现有逻辑已是），错误卡片与正文同屏，不替换整屏。
- **验证**：模拟失败（如断网进详情页），应看到错误卡片与「重试」；点击重试后 errorMessage 清空并再次请求，成功则错误消失。

---

## 步骤 3：下拉刷新失败反馈

- **文件**：`JUQI-APP/juqi/juqi/Views/Details/PostDetailView.swift`
- **修改**：
  1. `.refreshable { await loadDetail(); commentListRefreshTrigger = UUID() }` 保持不变；`loadDetail()` 内已对失败设置 `errorMessage`，刷新失败会自动显示同一错误态。
  2. 可选：在 refreshable 内 `await loadDetail()` 后若希望刷新成功时清除之前的错误，已由 `loadDetail()` 成功时 `errorMessage = nil` 覆盖。
- **验证**：进入详情页后下拉刷新，若请求失败，出现错误卡片与重试；已展示的帖子内容保留。

---

## 步骤 4：自检与收尾

- 对照设计文档与本文计划逐项检查。
- 在模拟器或真机跑一遍：进入帖子详情 → 断网或模拟失败 → 看到错误与重试 → 恢复网络点重试；下拉刷新失败 → 错误卡片与重试。
- 无新增 lint 报错，无遗留调试代码。

---

## 完成情况（2025-02-11）

- 步骤 1～3 已实现于 `PostDetailView.swift`：新增 `errorMessage`；`loadDetail()` 成功时 `errorMessage = nil`，失败时 `errorMessage = "加载失败，请重试"`；在 `ScrollView` 内顶部用 `EmptyStateView` 展示错误卡片与「重试」按钮，重试时清空错误并再次 `loadDetail()` 并刷新评论列表 trigger。下拉刷新仍调用 `loadDetail()`，失败时同一错误态展示。
- 验证方式：真机/模拟器手动自检（断网进详情、下拉刷新失败、点重试恢复）。
