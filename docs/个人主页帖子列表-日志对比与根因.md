# 个人主页帖子列表：日志对比与根因

## 一、两条日志的核心差异

| 项目 | 日志1：个人中心进自己主页（帖子不显示） | 日志2：其它地方进个人主页（正常） |
|------|----------------------------------------|----------------------------------|
| **入口** | 设置页点「发布」 | 动态/评论等点头像 |
| **isOwnProfile** | `true` | `false` |
| **传入的 userId** | `f77440a2647829d300096d9073057836`（32 位 hex，即 **user 表 _id**） | `onosB5lRKgCjonoNbj9peqM--e2Q`（**openId**） |
| **loadUserProfile** | 调 `getCurrentUserProfile`，返回 `profile.id = _id` | 调 `getUserProfile(userId)`，返回 `profile.id = _id` |
| **loadUserPosts 用的 targetUserId** | `userProfile?.id` → **f77440a2647829d300096d9073057836**（_id） | `userProfile?.id = nil` 时用 `userId` → **onosB5lRKgCjonoNbj9peqM--e2Q**（openId） |
| **appGetUserDynList 收到的 userId** | **f77440a2647829d300096d9073057836**（_id） | **onosB5lRKgCjonoNbj9peqM--e2Q**（openId） |
| **服务端查 dyn** | 用 `_id` 当 openId 查 → **0 条** | 用 openId 查 → **20 条** |
| **listCount** | **0** | **20** |

---

## 二、根因（数据与传参）

- **dyn 表按 openId 存**：拉取「某用户的动态列表」时，核心层用的是 **openId**，不是 user 表的 **_id**。
- **个人中心进自己主页**：  
  - 传入的 `userId` 来自 ProfileView 的 `profile?.id`，即 **GetCurrentUserProfile 返回的 id**，在 dataEnv=prod 时是生产库 **user 的 _id**（32 位 hex）。  
  - 之后 `targetUserId = userProfile?.id` 也是这个 **_id**，**appGetUserDynList 收到的是 _id**。  
  - 云函数里若把 _id 当 openId 传给 getDynsListV2（或未把 _id 解析成 openId），查 dyn 就会是 **0 条**。
- **其它入口进个人主页**：  
  - 传入的 `userId` 一般是** openId**（如从动态/评论里带出来的）。  
  - **appGetUserDynList 收到 openId**，直接按 openId 查 dyn，所以 **listCount=20** 正常。

结论：**差异就在「传给 appGetUserDynList 的 userId 是 _id 还是 openId」**。个人中心这条链路传的是 _id，服务端必须把 _id 解析成 openId 再查 dyn，否则列表必为 0。

---

## 三、服务端已做修复（resolveUserIdToOpenId）

- **问题**：原先只把 **24 位** hex 当成 _id（isMongoObjectId），**32 位** 的 _id 被当成 openId 直接传给 getDynsListV2，导致用 _id 查 dyn → 0 条。
- **修复**：  
  - 增加 **isLikelyDocId**：24 位或 **32 位** 十六进制都视为「可能是 _id」。  
  - **resolveUserIdToOpenId(db, userId)** 对这类 userId 用 `db.collection('user').doc(userId).get()` 查出 **openId** 再返回。  
  - GetUserDynList 里用 **targetOpenId = resolveUserIdToOpenId(db, userId) || userId**，保证传给 getDynsListV2 的是 **openId**。

部署 **appApi**（含上述 user.js 修改）后，个人中心进自己主页时：  
请求里仍是 `userId=f77440a2647829d300096d9073057836`，但服务端会先解析成 openId，再按 openId 拉 dyn，帖子列表应恢复正常。

---

## 四、客户端无需改

- 个人中心继续传 **profile?.id**（_id）没问题；  
- 其它入口继续传 **openId** 也没问题。  
服务端已统一支持「userId = _id 或 openId」，并在内部统一成 openId 再查 dyn。
