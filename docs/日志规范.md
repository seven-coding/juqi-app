# æ—¥å¿—è§„èŒƒï¼ˆApp + äº‘å‡½æ•°ï¼‰

ä¾¿äºæ’æŸ¥é—®é¢˜æ—¶æŒ‰ã€Œä¸€æ¬¡è¯·æ±‚ã€ä¸²è”å®¢æˆ·ç«¯ã€appApiã€å­äº‘å‡½æ•°å„å±‚æ—¥å¿—ã€‚

## 1. è¯·æ±‚ ID ä¸ä¼ é€’

- **appApi** å…¥å£ä¸ºæ¯æ¬¡è¯·æ±‚ç”Ÿæˆ `requestId`ï¼ˆå¦‚ `mabc123`ï¼‰ï¼Œå†™å…¥ `event.requestId`ï¼Œä¾›å„æ¨¡å—ä¸å­äº‘å‡½æ•°ä½¿ç”¨ã€‚
- **å­äº‘å‡½æ•°**ï¼šappApi åœ¨ `cloud.callFunction` çš„ `data` ä¸­ä¼ å…¥ `requestId: event.requestId || ''`ï¼Œå­äº‘å‡½æ•°ï¼ˆå¦‚ getDynDetailï¼‰ä» `event.requestId` è¯»å–å¹¶åœ¨æ‰€æœ‰æ—¥å¿—ä¸­å¸¦ `[reqId=xxx]`ã€‚
- **å“åº”**ï¼šappApi åœ¨æˆåŠŸ/é”™è¯¯å“åº”çš„æ ¹å¯¹è±¡ä¸Šå¢åŠ å¯é€‰å­—æ®µ `requestId`ï¼Œå®¢æˆ·ç«¯å¯æ‰“å°å¹¶ä¸äº‘ç«¯æ—¥å¿—å¯¹åº”ã€‚

## 2. æœåŠ¡ç«¯æ—¥å¿—æ ¼å¼

- **å‰ç¼€**ï¼š`[reqId=<id>][<operation>]`ï¼Œä¾‹å¦‚ `[reqId=mabc123][appGetDynDetail]`ã€‚
- **é˜¶æ®µä¸å‚æ•°**ï¼š`é˜¶æ®µ: key=value`ï¼Œå¤šå‚æ•°ç”¨é€—å·æˆ–ç©ºæ ¼åˆ†éš”ã€‚
- **ç¤ºä¾‹**
  - å…¥å‚ï¼š`[reqId=mabc123][appGetDynDetail] å…¥å‚: id=xxx, dataEnv=test, envId=test-juqi-xxx`
  - è°ƒç”¨å­äº‘å‡½æ•°ï¼š`[reqId=mabc123][appGetDynDetail] è°ƒç”¨å­äº‘å‡½æ•°: name=getDynDetailV201, id=xxx`
  - è¿”å›ï¼š`[reqId=mabc123][appGetDynDetail] è¿”å›: code=200, dynId=xxx`
  - é”™è¯¯ï¼š`[reqId=mabc123][appGetDynDetail] é”™è¯¯: code=404, message=åŠ¨æ€ä¸å­˜åœ¨, dynId=xxx`

åœ¨äº‘å‡½æ•°æ—¥å¿—ä¸­æŒ‰ `reqId=` æˆ– `requestId` ç­›é€‰å³å¯å¾—åˆ°å•æ¬¡è¯·æ±‚å…¨é“¾è·¯ã€‚

## 3. å®¢æˆ·ç«¯æ—¥å¿—æ ¼å¼

- **å‰ç¼€**ï¼š`[API]`ï¼Œå…³é”®æ—¥å¿—å¸¦ `req=`ï¼ˆæœ¬åœ°è¯·æ±‚ IDï¼‰ä¸ `requestId=`ï¼ˆæœåŠ¡ç«¯è¿”å›çš„ requestIdï¼Œè‹¥æœ‰ï¼‰ã€‚
- **ç¤ºä¾‹**
  - è¯·æ±‚å¼€å§‹ï¼š`ğŸ“¤ [API] req=a1b2c3d4 operation=appGetDynDetail dataEnv=test dataKeys=id`
  - å“åº”æˆåŠŸï¼š`âœ… [API] req=a1b2c3d4 requestId=mabc123 operation=appGetDynDetail code=200`
  - é”™è¯¯ï¼š`âŒ [API] req=a1b2c3d4 requestId=mabc123 operation=appGetDynDetail code=404 message=åŠ¨æ€ä¸å­˜åœ¨`

`req` ä¸ºå®¢æˆ·ç«¯æœ¬æ¬¡è¯·æ±‚çš„çŸ­ IDï¼ˆUUID å‰ 8 ä½ï¼‰ï¼Œä»…ç”¨äºæœ¬åœ°ä¸²è”åŒä¸€æ¬¡è°ƒç”¨çš„å¤šæ¡æ—¥å¿—ï¼›`requestId` ä¸äº‘ç«¯ä¸€è‡´ï¼Œä¾¿äºä¸äº‘å‡½æ•°æ—¥å¿—å¯¹é½ã€‚

## 4. å…³é”®å‚æ•°

- **æœåŠ¡ç«¯**ï¼šå…¥å£ä¸é”™è¯¯å¤„è‡³å°‘æ‰“å° `operation`ã€`dataEnv`ã€`envId`ï¼›ä¸šåŠ¡ç›¸å…³å¿…æ‰“ `id`/`dynId`/`userId` ç­‰ã€‚
- **å®¢æˆ·ç«¯**ï¼šè¯·æ±‚æ—¥å¿—å« `operation`ã€`dataEnv`ã€`dataKeys`ï¼ˆæˆ–å…³é”® data å­—æ®µï¼‰ï¼›é”™è¯¯å« `code`ã€`message`ã€‚
- ä¸æ‰“å°å®Œæ•´ tokenã€é•¿åˆ—è¡¨ï¼›ä»…æ‰“å° idã€æ•°é‡ã€dataEnv ç­‰çŸ­å­—æ®µã€‚

## 5. é”™è¯¯æ—¥å¿—

- é”™è¯¯æ—¥å¿—å¿…é¡»å¸¦ **reqId**ï¼ˆæœåŠ¡ç«¯ï¼‰æˆ– **req/requestId**ï¼ˆå®¢æˆ·ç«¯ï¼‰ã€**operation**ã€**code**ã€**message**ï¼Œä»¥åŠç›¸å…³ä¸šåŠ¡ idï¼ˆå¦‚ dynIdã€userIdï¼‰ï¼Œä¾¿äºå®šä½è¯·æ±‚ä¸èµ„æºã€‚

## 6. ç›¸å…³æ–‡ä»¶

- æœåŠ¡ç«¯ï¼š`cloudfunctions/appApi/index.js`ï¼ˆç”Ÿæˆå¹¶æ³¨å…¥ requestIdï¼‰ã€`appApi/modules/dyn.js`ã€`user.js`ã€`message.js`ã€`circle.js`ï¼›`getDynDetail/index.js`ã€‚
- å®¢æˆ·ç«¯ï¼š`juqi/juqi/Networking/NetworkService.swift`ï¼ˆlocalReqIdã€requestId è§£æä¸ç»Ÿä¸€ [API] å‰ç¼€ï¼‰ã€‚
