# App 架构约定与计划清单

本文档汇总过去讨论过的架构设定，便于查阅与对照。

---

## 一、规则文件中的约定（.cursor/rules）

### 1. App 版本与 v2 接口约定（app-v2-isolation.mdc）

| 项 | 内容 |
|----|------|
| **开发范围** | 当前开发对象为 **App 版本（JUQI-APP）**，不是小程序。 |
| **环境与云函数** | 仅使用 **测试环境** 及测试环境对应的云函数；所有功能改动、Bug 修复、新需求都在此范围内完成，不依赖或修改小程序线上环境。 |
| **代码隔离** | App 与小程序逻辑隔离：两套代码互不修改、互不依赖。只改 App 侧代码与云函数，不修改小程序仓库。 |
| **App 专用接口** | App 使用 **v2 版接口**（如 `app/v2/api`、operation 以 `app` 开头），由 JUQI-APP 下的 appApi 及对应云函数实现，部署在 **测试环境**。 |
| **调用链** | 确保 v2 请求只命中 App 测试环境中部署的云函数（appApi、getDynsListV2 等），不部署或覆盖为小程序侧云函数，避免 v2 走到小程序逻辑、影响线上。 |
| **实际操作** | 修 App 相关 Bug、加 App 功能：只改 **JUQI-APP** 目录（含 juqi 客户端与 cloudfunctions/apiServer）；云函数部署：v2 使用的环境仅部署 JUQI-APP 的云函数，与小程序部署隔离。 |

### 2. 测试环境云函数部署规则（test-env-cloud-deploy.mdc）

| 项 | 内容 |
|----|------|
| **原则** | 测试环境 **只部署 JUQI-APP 的云函数**；禁止将 JUQI-小程序 的云函数部署到测试环境。 |
| **原因** | 同名函数（如 getUserAbout、getDynsListV2）在 APP 与小程序侧实现不同，若误部署小程序版本会导致接口报错（如 getUserAbout 中 userInfo 未定义 500）。 |
| **部署操作** | 必须在 **JUQI-APP/cloudfunctions** 下执行 `node run-full-deploy.js`（或 `npm run deploy`），仅上传本目录内的云函数；不要在 JUQI-小程序/cloudfunctions 下对测试环境做部署。 |
| **函数列表** | 以 **JUQI-APP/cloudfunctions/cloudbaserc.json** 中的 `functions` 为唯一依据。 |

---

## 二、数据环境约定（dataEnv）

| 项 | 内容 |
|----|------|
| **正确逻辑** | 请求带 **dataEnv=prod** 时：用 **测试环境函数**，**生产环境数据**。 |
| **实现要点** | appApi 根据 `dataEnv` 做 `cloud.init(envId)`：dataEnv=prod 时 init 到生产 env，则 **db** 为生产库；子调用（如 callFunction）应避免命中生产环境未修复的云函数。 |
| **当前实现** | 在 GetUserProfile 中：dataEnv=prod 时 **不调用** 生产环境 getUserAbout，改为在 appApi 内用当前请求的 db（生产库）执行与 type=7 等价的逻辑（getOperateActionWithDb），以实现「测试环境函数逻辑 + 生产环境数据」。 |

---

## 三、接口架构设计（JUQI-APP/docs/接口架构设计.md）

### 3.1 架构原则

| 原则 | 说明 |
|------|------|
| **完全隔离** | App 接口与小程序接口完全独立；通过 appApi 作为 App 专用入口；App 不直接调用小程序使用的云函数。 |
| **数据共享** | App 与小程序共享同一数据库，数据完全一致，会员状态字段一致。 |
| **统一入口** | 所有 App 接口通过 appApi 统一调用，统一 Token 验证与响应格式。 |

### 3.2 分层结构

| 层 | 职责 |
|----|------|
| **客户端层（index.js）** | 入口、鉴权、参数适配、响应格式化。 |
| **业务版本层（modules/）** | App 特有业务逻辑、参数标准化、数据格式转换、可调用核心层或直接操作数据库。 |
| **业务核心层（现有云函数）** | 核心业务逻辑，不区分调用来源；接收标准化参数（openId 等），可被多版本复用。 |
| **数据层** | 共享数据库。 |

### 3.3 版本控制方案（推荐）

| 项 | 内容 |
|----|------|
| **核心思想** | 版本层处理差异，核心层保持纯净；核心层 **不接收 source 参数**，不区分调用来源。 |
| **版本层** | 参数标准化、Token 解析 openId、调用核心层时传标准化参数、数据格式转换。 |
| **核心层** | 只接收标准化参数，专注核心业务，不关心来源。 |
| **优势** | 单一职责、可维护性高、可扩展（新增 H5/Android 只需版本层）、核心层复用、测试简单。 |

### 3.4 开发注意事项（文档内）

- 所有 App 接口在 appApi 的 **业务版本层（modules）** 实现。
- 调用核心层时传递 **标准化参数**（实践中部分核心层仍接收 source/newApp 等以区分 HTTP 与小程序上下文，见 appApi 注释）。
- 确保小程序不受影响；数据与会员状态一致。

---

## 四、与当前实现的关系

| 主题 | 架构约定 | 当前实现 |
|------|----------|----------|
| **环境** | 仅使用测试环境及测试环境云函数 | appApi 部署在测试环境；按 dataEnv 切换 db 所在环境（test/prod）。 |
| **dataEnv=prod** | 测试环境函数 + 生产环境数据 | init(prod) 得到生产 db；GetUserProfile 在 dataEnv=prod 时用 getOperateActionWithDb(db) 代替 callFunction(getUserAbout)，避免调用生产环境未修复的 getUserAbout。 |
| **版本控制** | 版本层处理差异，核心层保持纯净 | 业务版本层（user/dyn 等）做参数与数据转换；核心层（getDynsListV2、login 等）接收 openId/source 等，由版本层传入。 |
| **在 appApi 内区分 dataEnv** | 文档未明确禁止 | 当前在 user 模块内根据 event.dataEnv 分支（prod 用本地逻辑，test 用 callFunction）。若约定「只在入口区分环境、子调用统一走测试环境」，则更一致的做法是：子调用统一走测试环境，或生产环境也部署同一份 getUserAbout。 |

---

## 五、可后续补充的约定

- **子调用环境**：是否明确「所有 cloud.callFunction 在 dataEnv=prod 时均调用测试环境云函数」；若采用，需实现方式（如双 cloud 实例或生产环境同步部署修复版）。
- **dataEnv 暴露范围**：是否仅限入口（index.js）使用 dataEnv 做 init，业务模块不根据 dataEnv 分支，以避免各模块重复判断环境。

---

*文档生成自当前仓库规则与 JUQI-APP/docs 内容，便于团队统一查看架构设定。*
